<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Cloud Practitioner AI Exam Portal</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin
        src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // SVG Icons (added missing Server icon)
        const Upload = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>);
        const CheckCircle = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></svg>);
        const XCircle = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10" /><line x1="15" y1="9" x2="9" y2="15" /><line x1="9" y1="9" x2="15" y2="15" /></svg>);
        const RotateCcw = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></svg>);
        const Download = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2 2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>);
        const Clock = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>);
        const Award = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="8" r="7" /><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" /></svg>);
        const BookOpen = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></svg>);
        const Flag = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" y1="22" x2="4" y2="15" /></svg>);
        const BarChart = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10" /><line x1="18" y1="20" x2="18" y2="4" /><line x1="6" y1="20" x2="6" y2="16" /></svg>);
        const Eye = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></svg>);
        const AlertCircle = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" /></svg>);
        const User = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>);
        const Users = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>);
        const FileText = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></svg>);
        const Database = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></svg>);
        const Trash = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>);
        const History = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v5h5" /><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8" /><path d="M12 7v5l4 2" /></svg>);
        const Brain = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-2.5 2.5h-2A2.5 2.5 0 0 1 5 19.5v-15A2.5 2.5 0 0 1 7.5 2h2Z" /><path d="M14.5 2A2.5 2.5 0 0 1 17 4.5v15a2.5 2.5 0 0 1-2.5 2.5h-2A2.5 2.5 0 0 1 10 19.5v-15A2.5 2.5 0 0 1 12.5 2h2Z" /></svg>);
        const Zap = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></svg>);
        const Target = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></svg>);
        const PieChart = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></svg>);
        const TrendingUp = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></svg>);
        const Calculator = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="4" y="2" width="16" height="20" rx="2" /><line x1="8" y1="6" x2="16" y2="6" /><line x1="8" y1="10" x2="16" y2="10" /><line x1="8" y1="14" x2="12" y2="14" /><line x1="16" y1="14" x2="16" y2="18" /></svg>);
        const Server = () => (<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="2" width="20" height="8" rx="2" ry="2" /><rect x="2" y="14" width="20" height="8" rx="2" ry="2" /><line x1="6" y1="6" x2="6.01" y2="6" /><line x1="6" y1="18" x2="6.01" y2="18" /></svg>);

        // AWS Cloud Practitioner Domains (keep existing domains)
        const awsDomains = [
            {
                name: "Domain 1: Cloud Concepts (24%)",
                topics: [
                    "Pay-as-you-go pricing",
                    "Scalability and Elasticity",
                    "High availability",
                    "Global reach (Regions/Availability Zones)",
                    "Agility",
                    "Cost savings (economies of scale)",
                    "Well-Architected Framework (6 Pillars)",
                    "Cloud Migration strategies",
                    "AWS CAF (Cloud Adoption Framework)",
                    "Cloud Economics (CapEx vs OpEx)",
                    "Rightsizing and managed services"
                ]
            },
            {
                name: "Domain 2: Security and Compliance (30%)",
                topics: [
                    "AWS Shared Responsibility Model",
                    "Security, Governance, Compliance",
                    "AWS Artifact and compliance programs",
                    "Logging (CloudTrail, CloudWatch)",
                    "Monitoring (Security Hub, GuardDuty)",
                    "Encryption (at rest & in transit)",
                    "Identity & Access Management (IAM)",
                    "Root user protection and MFA",
                    "IAM Identity Center (SSO)",
                    "Security Tools (WAF, Shield)",
                    "Network ACLs, Security Groups"
                ]
            },
            {
                name: "Domain 3: Cloud Technology and Services (34%)",
                topics: [
                    "Deployment & Operations",
                    "AWS Global Infrastructure",
                    "Compute Services (EC2, Lambda)",
                    "Database Services (RDS, DynamoDB)",
                    "Networking (VPC, Route 53)",
                    "Storage (S3, EBS, EFS)",
                    "AI/ML & Analytics services",
                    "Application Integration (SNS, SQS)",
                    "Developer Tools",
                    "IoT and other AWS services"
                ]
            },
            {
                name: "Domain 4: Billing, Pricing & Support (12%)",
                topics: [
                    "AWS Pricing Models",
                    "Cost Management Tools",
                    "AWS Budgets and Cost Explorer",
                    "Cost allocation tags",
                    "AWS Organizations",
                    "AWS Support Plans",
                    "Technical Resources",
                    "Trusted Advisor",
                    "AWS Health Dashboard"
                ]
            }
        ];

        // AWS Services for Service-Wise Practice
        const awsServices = [
            {
                category: "Core Services & Concepts",
                services: [
                    "Benefits of migrating to the AWS Cloud",
                    "AWS Cloud Adoption Framework (AWS CAF)",
                    "AWS Compliance",
                    "AWS global infrastructure (AWS Regions, Availability Zones)",
                    "AWS shared responsibility model",
                    "AWS Well-Architected Framework",
                    "AWS Pricing Calculator",
                    "AWS Support plans",
                    "AWS Knowledge Center",
                    "AWS re:Post",
                    "AWS Security Blog",
                    "AWS Security Center",
                    "AWS Solutions Architects",
                    "AWS Professional Services",
                    "AWS Partner Network",
                    "AWS Prescriptive Guidance"
                ]
            },
            {
                category: "Compute Services",
                services: [
                    "Amazon EC2",
                    "Amazon EC2 instance types (Reserved, On-Demand, Spot)",
                    "AWS Lambda",
                    "AWS Batch",
                    "AWS Elastic Beanstalk",
                    "Amazon Lightsail",
                    "AWS Local Zones",
                    "AWS Outposts",
                    "AWS Wavelength"
                ]
            },
            {
                category: "Storage Services",
                services: [
                    "Amazon S3",
                    "Amazon S3 Glacier",
                    "Amazon Elastic Block Store (Amazon EBS)",
                    "Amazon Elastic File System (Amazon EFS)",
                    "Amazon FSx",
                    "AWS Backup",
                    "AWS Elastic Disaster Recovery",
                    "AWS Storage Gateway"
                ]
            },
            {
                category: "Database Services",
                services: [
                    "Amazon RDS",
                    "Amazon Aurora",
                    "Amazon DynamoDB",
                    "Amazon MemoryDB for Redis",
                    "Amazon Neptune",
                    "Amazon Redshift"
                ]
            },
            {
                category: "Networking & Content Delivery",
                services: [
                    "Amazon VPC",
                    "Amazon Route 53",
                    "Amazon CloudFront",
                    "AWS Direct Connect",
                    "AWS Global Accelerator",
                    "Amazon API Gateway",
                    "AWS VPN"
                ]
            },
            {
                category: "Security, Identity & Compliance",
                services: [
                    "AWS IAM",
                    "AWS IAM Identity Center (AWS Single Sign-On)",
                    "AWS Key Management Service (AWS KMS)",
                    "AWS Shield",
                    "AWS WAF",
                    "Amazon GuardDuty",
                    "Amazon Inspector",
                    "Amazon Macie",
                    "Amazon Detective",
                    "AWS Security Hub",
                    "AWS Artifact",
                    "AWS Audit Manager",
                    "AWS Certificate Manager (ACM)",
                    "AWS CloudHSM",
                    "Amazon Cognito",
                    "AWS Directory Service",
                    "AWS Firewall Manager",
                    "AWS Resource Access Manager (AWS RAM)",
                    "AWS Secrets Manager"
                ]
            },
            {
                category: "Management & Governance",
                services: [
                    "AWS Management Console",
                    "AWS CLI",
                    "AWS CloudFormation",
                    "AWS CloudTrail",
                    "Amazon CloudWatch",
                    "AWS Config",
                    "AWS Organizations",
                    "AWS Control Tower",
                    "AWS Systems Manager",
                    "AWS Auto Scaling",
                    "AWS Trusted Advisor",
                    "AWS Well-Architected Tool",
                    "AWS Service Catalog",
                    "AWS Resource Groups and Tag Editor",
                    "AWS Compute Optimizer",
                    "AWS License Manager",
                    "AWS Health Dashboard",
                    "AWS Launch Wizard"
                ]
            },
            {
                category: "Analytics Services",
                services: [
                    "Amazon Athena",
                    "Amazon EMR",
                    "AWS Glue",
                    "Amazon Kinesis",
                    "Amazon Managed Streaming for Apache Kafka (Amazon MSK)",
                    "Amazon OpenSearch Service",
                    "Amazon QuickSight",
                    "AWS Data Exchange"
                ]
            },
            {
                category: "Application Integration",
                services: [
                    "Amazon Simple Notification Service (Amazon SNS)",
                    "Amazon Simple Queue Service (Amazon SQS)",
                    "Amazon EventBridge",
                    "AWS Step Functions"
                ]
            },
            {
                category: "Developer Tools",
                services: [
                    "AWS CodeCommit",
                    "AWS CodeBuild",
                    "AWS CodeDeploy",
                    "AWS CodePipeline",
                    "AWS CodeStar",
                    "AWS X-Ray",
                    "AWS Cloud9",
                    "AWS CloudShell",
                    "AWS CodeArtifact",
                    "AWS AppConfig"
                ]
            },
            {
                category: "Machine Learning",
                services: [
                    "Amazon SageMaker",
                    "Amazon Comprehend",
                    "Amazon Kendra",
                    "Amazon Lex",
                    "Amazon Polly",
                    "Amazon Rekognition",
                    "Amazon Textract",
                    "Amazon Transcribe",
                    "Amazon Translate"
                ]
            },
            {
                category: "Migration & Transfer",
                services: [
                    "AWS Application Discovery Service",
                    "AWS Application Migration Service",
                    "AWS Database Migration Service (AWS DMS)",
                    "AWS Migration Hub",
                    "AWS Schema Conversion Tool (AWS SCT)",
                    "AWS Snow Family",
                    "AWS Transfer Family"
                ]
            },
            {
                category: "Containers",
                services: [
                    "Amazon Elastic Container Service (Amazon ECS)",
                    "Amazon Elastic Kubernetes Service (Amazon EKS)",
                    "Amazon Elastic Container Registry (Amazon ECR)",
                    "AWS Fargate"
                ]
            },
            {
                category: "End User Computing",
                services: [
                    "Amazon WorkSpaces",
                    "Amazon WorkSpaces Web",
                    "Amazon AppStream 2.0"
                ]
            },
            {
                category: "Frontend Web & Mobile",
                services: [
                    "AWS Amplify",
                    "AWS AppSync",
                    "AWS Device Farm"
                ]
            },
            {
                category: "Internet of Things (IoT)",
                services: [
                    "AWS IoT Core",
                    "AWS IoT Greengrass"
                ]
            },
            {
                category: "Business Applications",
                services: [
                    "Amazon Connect",
                    "Amazon Simple Email Service (Amazon SES)"
                ]
            },
            {
                category: "Customer Engagement",
                services: [
                    "AWS Activate for Startups",
                    "AWS IQ",
                    "AWS Managed Services (AMS)",
                    "AWS Support"
                ]
            },
            {
                category: "Cloud Financial Management",
                services: [
                    "AWS Billing Conductor",
                    "AWS Budgets",
                    "AWS Cost and Usage Report",
                    "AWS Cost Explorer",
                    "AWS Marketplace"
                ]
            },
            {
                category: "Serverless",
                services: [
                    "AWS Lambda",
                    "AWS Fargate",
                    "Amazon API Gateway",
                    "Amazon DynamoDB",
                    "Amazon S3",
                    "Amazon SNS",
                    "Amazon SQS",
                    "Amazon EventBridge",
                    "AWS Step Functions"
                ]
            }
        ];

        // Aptitude and Reasoning Topics (keep existing)
        const aptitudeTopics = [
            {
                name: "Quantitative Aptitude",
                topics: [
                    "Number Systems",
                    "Percentage",
                    "Profit and Loss",
                    "Ratio and Proportion",
                    "Time and Work",
                    "Time, Speed and Distance",
                    "Simple and Compound Interest",
                    "Data Interpretation"
                ]
            },
            {
                name: "Logical Reasoning",
                topics: [
                    "Number Series",
                    "Letter Series",
                    "Analogies",
                    "Blood Relations",
                    "Direction Sense",
                    "Coding-Decoding",
                    "Syllogisms",
                    "Logical Deductions"
                ]
            },
            {
                name: "Verbal Reasoning",
                topics: [
                    "Reading Comprehension",
                    "Sentence Correction",
                    "Synonyms and Antonyms",
                    "Idioms and Phrases",
                    "One Word Substitution",
                    "Para Jumbles",
                    "Critical Reasoning"
                ]
            }
        ];

        const ExamSystem = () => {
            const [userRole, setUserRole] = useState(null);
            const [userName, setUserName] = useState('');
            const [questions, setQuestions] = useState([]);
            const [answers, setAnswers] = useState([]);
            const [userAnswers, setUserAnswers] = useState({});
            const [flaggedQuestions, setFlaggedQuestions] = useState(new Set());
            const [showResults, setShowResults] = useState(false);
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [timeLeft, setTimeLeft] = useState(9000);
            const [examStarted, setExamStarted] = useState(false);
            const [score, setScore] = useState(0);
            const [examHistory, setExamHistory] = useState([]);
            const [showStats, setShowStats] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            const [examTitle, setExamTitle] = useState('AWS Cloud Practitioner Exam');
            const [showReview, setShowReview] = useState(false);
            const [showConfirmSubmit, setShowConfirmSubmit] = useState(false);
            const [allStudents, setAllStudents] = useState([]);
            const [teacherView, setTeacherView] = useState('dashboard');
            const [selectedHistoryExam, setSelectedHistoryExam] = useState(null);
            const [selectedDomains, setSelectedDomains] = useState([]);
            const [selectedServices, setSelectedServices] = useState([]);
            const [questionCount, setQuestionCount] = useState(10);
            const [difficulty, setDifficulty] = useState('medium');
            const [generatingQuestions, setGeneratingQuestions] = useState(false);
            const [explanations, setExplanations] = useState({});
            const [showExplanation, setShowExplanation] = useState(false);
            const [currentExplanation, setCurrentExplanation] = useState(null);
            const [practiceMode, setPracticeMode] = useState(false);
            const [showDomainSelector, setShowDomainSelector] = useState(false);
            const [showServiceSelector, setShowServiceSelector] = useState(false);
            const [showQuestionGenerator, setShowQuestionGenerator] = useState(false);
            const [domainPerformance, setDomainPerformance] = useState({});
            const [showDomainAnalysis, setShowDomainAnalysis] = useState(false);
            const [examType, setExamType] = useState('aws'); // 'aws' or 'aptitude'
            const [showAptitudeSelector, setShowAptitudeSelector] = useState(false);
            const [selectedAptitudeTopics, setSelectedAptitudeTopics] = useState([]);

            // NEW: Store current exam questions for retaking
            const [currentExamQuestions, setCurrentExamQuestions] = useState([]);
            const [currentExamAnswers, setCurrentExamAnswers] = useState([]);

            // PYQ (Previous Year Questions) State Variables
            const [pyqQuestions, setPyqQuestions] = useState([]);
            const [showPyqUpload, setShowPyqUpload] = useState(false);
            const [showPyqPractice, setShowPyqPractice] = useState(false);
            const [pyqQuestionFile, setPyqQuestionFile] = useState('');
            const [selectedPyqSet, setSelectedPyqSet] = useState(null);
            const [teacherPyqView, setTeacherPyqView] = useState('manage');
            const [pyqQuestionCount, setPyqQuestionCount] = useState(10);
            const [selectedPyqSetForPractice, setSelectedPyqSetForPractice] = useState(null);
            const [showPyqQuestionCountSelector, setShowPyqQuestionCountSelector] = useState(false);

            // Initialize JSON Storage
            useEffect(() => {
                loadAllStudents();
                loadPyqQuestions();
                if (userRole === 'student') {
                    loadStudentExamHistory();
                }
            }, [userRole]);

            // Load all students for teacher view
            const loadAllStudents = () => {
                try {
                    const storedData = localStorage.getItem('awsExamStudents');
                    if (storedData) {
                        const studentsData = JSON.parse(storedData);
                        setAllStudents(studentsData);
                    }
                } catch (error) {
                    console.error('Error loading students:', error);
                }
            };

            // Load student's exam history
            const loadStudentExamHistory = () => {
                if (!userName) return;

                try {
                    const storedData = localStorage.getItem('awsExamResults');
                    if (storedData) {
                        const allResults = JSON.parse(storedData);
                        const studentResults = allResults.filter(result => result.studentName === userName);
                        setExamHistory(studentResults);
                    }
                } catch (error) {
                    console.error('Error loading exam history:', error);
                }
            };

            // Load PYQ questions from storage
            const loadPyqQuestions = () => {
                try {
                    const storedPyq = localStorage.getItem('awsExamPYQ');
                    if (storedPyq) {
                        setPyqQuestions(JSON.parse(storedPyq));
                    }
                } catch (error) {
                    console.error('Error loading PYQ questions:', error);
                }
            };

            // Save PYQ questions to storage
            const savePyqQuestions = (questions) => {
                try {
                    localStorage.setItem('awsExamPYQ', JSON.stringify(questions));
                    setPyqQuestions(questions);
                } catch (error) {
                    console.error('Error saving PYQ questions:', error);
                }
            };

            // Save student to JSON storage
            const saveStudentToDatabase = (name, role) => {
                try {
                    const storedData = localStorage.getItem('awsExamStudents');
                    let students = storedData ? JSON.parse(storedData) : [];

                    // Check if student already exists
                    const existingStudentIndex = students.findIndex(s => s.name === name);

                    if (existingStudentIndex >= 0) {
                        // Update existing student
                        students[existingStudentIndex].role = role;
                        students[existingStudentIndex].updatedAt = new Date().toISOString();
                    } else {
                        // Add new student
                        students.push({
                            id: Date.now().toString(),
                            name: name,
                            role: role,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        });
                    }

                    localStorage.setItem('awsExamStudents', JSON.stringify(students));
                    setAllStudents(students);
                    return true;
                } catch (error) {
                    console.error('Error saving student:', error);
                    return false;
                }
            };

            // Save exam results to JSON storage
            const saveExamToDatabase = (examData) => {
                try {
                    const storedData = localStorage.getItem('awsExamResults');
                    let examResults = storedData ? JSON.parse(storedData) : [];

                    examResults.push({
                        id: Date.now().toString(),
                        studentName: examData.studentName,
                        examTitle: examData.examTitle,
                        score: examData.score,
                        totalQuestions: examData.total,
                        percentage: examData.percentage,
                        timeSpent: examData.timeSpent,
                        dateCreated: new Date().toISOString(),
                        questions: examData.questions,
                        answers: examData.answers,
                        userAnswers: examData.userAnswers,
                        examType: examData.examType,
                        domainPerformance: examData.domainPerformance
                    });

                    localStorage.setItem('awsExamResults', JSON.stringify(examResults));
                    console.log('Exam results saved to JSON storage');
                    loadStudentExamHistory();
                    loadAllStudents();
                } catch (error) {
                    console.error('Error saving exam results:', error);
                }
            };

            // Delete student and their data
            const deleteStudent = (studentName) => {
                try {
                    // Delete student from students list
                    const storedStudents = localStorage.getItem('awsExamStudents');
                    if (storedStudents) {
                        let students = JSON.parse(storedStudents);
                        students = students.filter(s => s.name !== studentName);
                        localStorage.setItem('awsExamStudents', JSON.stringify(students));
                        setAllStudents(students);
                    }

                    // Delete student's exam results
                    const storedResults = localStorage.getItem('awsExamResults');
                    if (storedResults) {
                        let examResults = JSON.parse(storedResults);
                        examResults = examResults.filter(result => result.studentName !== studentName);
                        localStorage.setItem('awsExamResults', JSON.stringify(examResults));
                    }

                    console.log(`Student ${studentName} deleted successfully`);
                } catch (error) {
                    console.error('Error deleting student:', error);
                }
            };

            // Delete specific exam result
            const deleteExamResult = (examId) => {
                try {
                    const storedResults = localStorage.getItem('awsExamResults');
                    if (storedResults) {
                        let examResults = JSON.parse(storedResults);
                        examResults = examResults.filter(result => result.id !== examId);
                        localStorage.setItem('awsExamResults', JSON.stringify(examResults));
                        loadStudentExamHistory();
                        loadAllStudents();
                        console.log('Exam result deleted successfully');
                    }
                } catch (error) {
                    console.error('Error deleting exam result:', error);
                }
            };

            // Load a previous exam attempt for review
            const loadPreviousExam = (examData) => {
                setQuestions(examData.questions);
                setAnswers(examData.answers);
                setUserAnswers(examData.userAnswers);
                setScore(examData.score);
                setExamTitle(`${examData.examTitle} (Previous Attempt)`);
                setShowResults(true);
                setShowStats(false);
                setSelectedHistoryExam(null);
            };

            // Parse uploaded question sheet
            const parseQuestionSheet = (text) => {
                const questions = [];
                const lines = text.split('\n');
                let currentQuestion = null;
                let currentTopic = '';

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    if (!line) continue;

                    // Detect topic
                    if (line.startsWith('Topic ')) {
                        currentTopic = line;
                        continue;
                    }

                    // Detect question
                    if (line.startsWith('Question #')) {
                        if (currentQuestion) {
                            questions.push(currentQuestion);
                        }
                        currentQuestion = {
                            question: '',
                            options: [],
                            answer: '',
                            topic: currentTopic,
                            isMultiSelect: false
                        };
                        continue;
                    }

                    // Detect question text
                    if (currentQuestion && !currentQuestion.question && line &&
                        !line.startsWith('A. ') && !line.startsWith('B. ') &&
                        !line.startsWith('C. ') && !line.startsWith('D. ') &&
                        !line.startsWith('E. ') && !line.startsWith('F. ') &&
                        !line.startsWith('Correct Answer:') &&
                        !line.startsWith('Community vote distribution')) {
                        currentQuestion.question = line;
                        continue;
                    }

                    // Detect options
                    if (line.startsWith('A. ') || line.startsWith('B. ') ||
                        line.startsWith('C. ') || line.startsWith('D. ') ||
                        line.startsWith('E. ') || line.startsWith('F. ')) {
                        if (currentQuestion) {
                            currentQuestion.options.push(line);
                        }
                        continue;
                    }

                    // Detect correct answer
                    if (line.startsWith('Correct Answer:')) {
                        if (currentQuestion) {
                            const answer = line.replace('Correct Answer:', '').trim();
                            currentQuestion.answer = answer;
                            currentQuestion.isMultiSelect = answer.includes(',') || answer.split('').filter(a => a.trim()).length > 1;
                        }
                        continue;
                    }
                }

                // Add the last question
                if (currentQuestion && currentQuestion.question) {
                    questions.push(currentQuestion);
                }

                return questions;
            };

            // Upload PYQ questions
            const handlePyqUpload = () => {
                if (!pyqQuestionFile.trim()) {
                    alert('Please paste your question sheet');
                    return;
                }

                try {
                    const parsedQuestions = parseQuestionSheet(pyqQuestionFile);

                    if (parsedQuestions.length === 0) {
                        alert('No valid questions found in the provided text. Please check the format.');
                        return;
                    }

                    // Create a new PYQ set
                    const newPyqSet = {
                        id: Date.now().toString(),
                        name: `PYQ Set ${new Date().toLocaleDateString()}`,
                        questions: parsedQuestions,
                        uploadedAt: new Date().toISOString(),
                        questionCount: parsedQuestions.length
                    };

                    // Save to storage
                    const updatedPyq = [...pyqQuestions, newPyqSet];
                    savePyqQuestions(updatedPyq);

                    setPyqQuestionFile('');
                    setShowPyqUpload(false);
                    alert(`Successfully uploaded ${parsedQuestions.length} questions!`);

                } catch (error) {
                    console.error('Error parsing question sheet:', error);
                    alert('Error parsing question sheet. Please check the format and try again.');
                }
            };

            // Enhanced PYQ Practice with question count selection and shuffling
            const startPyqPractice = (pyqSet, count = null) => {
                const questionCount = count || pyqQuestionCount;

                if (!pyqSet || !pyqSet.questions || pyqSet.questions.length === 0) {
                    alert('No questions available in this PYQ set');
                    return;
                }

                // Shuffle the questions array
                const shuffledQuestions = [...pyqSet.questions].sort(() => Math.random() - 0.5);

                // Take the requested number of questions (or all if less than requested)
                const selectedQuestions = shuffledQuestions.slice(0, Math.min(questionCount, pyqSet.questions.length));

                setSelectedPyqSet(pyqSet);
                setQuestions(selectedQuestions);
                setAnswers(selectedQuestions.map(q => q.answer));
                setExamTitle(`PYQ Practice: ${pyqSet.name} (${selectedQuestions.length} questions)`);
                setPracticeMode(true);
                setExamStarted(true);

                // Calculate time based on question count (1.5 minutes per question)
                const totalTime = selectedQuestions.length * 90;
                setTimeLeft(totalTime);

                setUserAnswers({});
                setShowResults(false);
                setCurrentQuestion(0);
                setFlaggedQuestions(new Set());
                setExamType('pyq');
                setShowPyqPractice(false);
                setShowPyqQuestionCountSelector(false);
            };

            // Delete PYQ set
            const deletePyqSet = (pyqId) => {
                if (confirm('Are you sure you want to delete this PYQ set?')) {
                    const updatedPyq = pyqQuestions.filter(set => set.id !== pyqId);
                    savePyqQuestions(updatedPyq);
                }
            };

            // AI Question Generation with enhanced multiple selection support
            const generateQuestionsWithAI = async (domains, count, difficulty, examType) => {
                setGeneratingQuestions(true);

                try {
                    // Extract topics from selected domains
                    const selectedTopics = domains.flatMap(domain => domain.topics);

                    // Create a prompt for the AI with enhanced multiple selection support
                    const prompt = `Generate ${count} multiple-choice questions for AWS Cloud Practitioner exam focusing on: ${selectedTopics.join(', ')}. 
                    Difficulty level: ${difficulty}. 
                    Format: 
                    - For single-answer questions: Provide exactly 4 options (A, B, C, D)
                    - For "choose two" questions: Provide exactly 5 options (A, B, C, D, E) with exactly 2 correct answers
                    - For "choose three" questions: Provide exactly 6 options (A, B, C, D, E, F) with exactly 3 correct answers
                    - 30% of questions should be multi-select (with 2 or 3 correct answers). Format multi-select answers as comma-separated letters (e.g., "A,C" or "B,D,F").
                    - Include the phrase "Choose two" or "Choose three" in the question text for multi-select questions
                    Format the response as JSON: { "questions": [ { "question": "question text", "options": ["A. option1", "B. option2", "C. option3", "D. option4"], "answer": "A" } ] }`;

                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyCR5TIp-MG3WmAiHZkCPXrKvHVYAMjcsoU', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: prompt
                                        }
                                    ]
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to generate questions');
                    }

                    const data = await response.json();

                    // Extract the generated text
                    const generatedText = data.candidates[0].content.parts[0].text;

                    // Try to parse the JSON from the response
                    let jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsedData = JSON.parse(jsonMatch[0]);

                        // Save questions to JSON file
                        saveQuestionsToJSON(parsedData.questions);

                        // Set questions and answers
                        const newQuestions = parsedData.questions.map(q => ({
                            question: q.question,
                            options: q.options,
                            isMultiSelect: q.answer.includes(',') // Check if it's multi-select
                        }));

                        const newAnswers = parsedData.questions.map(q => q.answer);

                        setQuestions(newQuestions);
                        setAnswers(newAnswers);

                        // NEW: Store current exam for retaking
                        setCurrentExamQuestions(newQuestions);
                        setCurrentExamAnswers(newAnswers);

                        if (examType === 'domain') {
                            const domainNames = domains.map(d => d.name.split(':')[0]);
                            setExamTitle(`Domain Practice: ${domainNames.join(', ')}`);
                        } else if (examType === 'full') {
                            setExamTitle('Full Practice Exam (60 Questions)');
                        } else if (examType === 'service') {
                            const serviceNames = domains.map(d => d.name);
                            setExamTitle(`Service Practice: ${serviceNames.join(', ')}`);
                        } else {
                            setExamTitle('AI Generated Practice Test');
                        }

                        // Start the exam
                        setPracticeMode(true);
                        setExamStarted(true);
                        setTimeLeft(count * 90); // 1.5 minutes per question
                        setUserAnswers({});
                        setShowResults(false);
                        setCurrentQuestion(0);
                        setFlaggedQuestions(new Set());
                    } else {
                        // Fallback to enhanced sample questions if parsing fails
                        console.error('Failed to parse AI response, using enhanced sample questions');
                        generateEnhancedSampleQuestions();
                    }
                } catch (error) {
                    console.error('Error generating questions with AI:', error);
                    // Fallback to enhanced sample questions
                    generateEnhancedSampleQuestions();
                } finally {
                    setGeneratingQuestions(false);
                }
            };

            // Generate Service-Wise Questions
            const generateServiceWiseQuestions = async (services, count, difficulty) => {
                setGeneratingQuestions(true);

                try {
                    // Extract service names
                    const selectedServices = services.map(service => service.name || service);

                    // Create a prompt for the AI with enhanced multiple selection support
                    const prompt = `Generate ${count} multiple-choice questions for AWS Cloud Practitioner exam focusing on these AWS services: ${selectedServices.join(', ')}. 
                    Difficulty level: ${difficulty}. 
                    Format: 
                    - For single-answer questions: Provide exactly 4 options (A, B, C, D)
                    - For "choose two" questions: Provide exactly 5 options (A, B, C, D, E) with exactly 2 correct answers
                    - For "choose three" questions: Provide exactly 6 options (A, B, C, D, E, F) with exactly 3 correct answers
                    - 30% of questions should be multi-select (with 2 or 3 correct answers). Format multi-select answers as comma-separated letters (e.g., "A,C" or "B,D,F").
                    - Include the phrase "Choose two" or "Choose three" in the question text for multi-select questions
                    - Focus on practical use cases, features, and benefits of each AWS service
                    Format the response as JSON: { "questions": [ { "question": "question text", "options": ["A. option1", "B. option2", "C. option3", "D. option4"], "answer": "A" } ] }`;

                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyCR5TIp-MG3WmAiHZkCPXrKvHVYAMjcsoU', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: prompt
                                        }
                                    ]
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to generate questions');
                    }

                    const data = await response.json();

                    // Extract the generated text
                    const generatedText = data.candidates[0].content.parts[0].text;

                    // Try to parse the JSON from the response
                    let jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsedData = JSON.parse(jsonMatch[0]);

                        // Set questions and answers
                        const newQuestions = parsedData.questions.map(q => ({
                            question: q.question,
                            options: q.options,
                            isMultiSelect: q.answer.includes(',') // Check if it's multi-select
                        }));

                        const newAnswers = parsedData.questions.map(q => q.answer);

                        setQuestions(newQuestions);
                        setAnswers(newAnswers);

                        // NEW: Store current exam for retaking
                        setCurrentExamQuestions(newQuestions);
                        setCurrentExamAnswers(newAnswers);

                        const serviceNames = selectedServices.slice(0, 3).join(', ');
                        setExamTitle(`Service Practice: ${serviceNames}${selectedServices.length > 3 ? '...' : ''}`);

                        // Start the exam
                        setPracticeMode(true);
                        setExamStarted(true);
                        setTimeLeft(count * 90); // 1.5 minutes per question
                        setUserAnswers({});
                        setShowResults(false);
                        setCurrentQuestion(0);
                        setFlaggedQuestions(new Set());
                        setExamType('aws');
                    } else {
                        // Fallback to enhanced sample questions if parsing fails
                        console.error('Failed to parse AI response, using enhanced sample questions');
                        generateEnhancedSampleQuestions();
                    }
                } catch (error) {
                    console.error('Error generating service-wise questions with AI:', error);
                    // Fallback to enhanced sample questions
                    generateEnhancedSampleQuestions();
                } finally {
                    setGeneratingQuestions(false);
                }
            };

            // Generate Aptitude Questions with enhanced multiple selection support
            const generateAptitudeQuestions = async (topics, count, difficulty) => {
                setGeneratingQuestions(true);

                try {
                    // Extract topics from selected aptitude areas
                    const selectedTopics = topics.flatMap(topic => topic.topics);

                    // Create a prompt for the AI with enhanced multiple selection support
                    const prompt = `Generate ${count} multiple-choice aptitude and reasoning questions focusing on: ${selectedTopics.join(', ')}. 
                    Difficulty level: ${difficulty}. 
                    Format: 
                    - For single-answer questions: Provide exactly 4 options (A, B, C, D)
                    - For "choose two" questions: Provide exactly 5 options (A, B, C, D, E) with exactly 2 correct answers
                    - For "choose three" questions: Provide exactly 6 options (A, B, C, D, E, F) with exactly 3 correct answers
                    - 20% of questions should be multi-select (with 2 or 3 correct answers). Format multi-select answers as comma-separated letters (e.g., "A,C" or "B,D,F").
                    - Include the phrase "Choose two" or "Choose three" in the question text for multi-select questions
                    Format the response as JSON: { "questions": [ { "question": "question text", "options": ["A. option1", "B. option2", "C. option3", "D. option4"], "answer": "A" } ] }`;

                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyCR5TIp-MG3WmAiHZkCPXrKvHVYAMjcsoU', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: prompt
                                        }
                                    ]
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to generate questions');
                    }

                    const data = await response.json();

                    // Extract the generated text
                    const generatedText = data.candidates[0].content.parts[0].text;

                    // Try to parse the JSON from the response
                    let jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsedData = JSON.parse(jsonMatch[0]);

                        // Set questions and answers
                        const newQuestions = parsedData.questions.map(q => ({
                            question: q.question,
                            options: q.options,
                            isMultiSelect: q.answer.includes(',') // Check if it's multi-select
                        }));

                        const newAnswers = parsedData.questions.map(q => q.answer);

                        setQuestions(newQuestions);
                        setAnswers(newAnswers);

                        // NEW: Store current exam for retaking
                        setCurrentExamQuestions(newQuestions);
                        setCurrentExamAnswers(newAnswers);

                        const topicNames = topics.map(t => t.name);
                        setExamTitle(`Aptitude Practice: ${topicNames.join(', ')}`);

                        // Start the exam
                        setPracticeMode(true);
                        setExamStarted(true);
                        setTimeLeft(count * 90); // 1.5 minutes per question
                        setUserAnswers({});
                        setShowResults(false);
                        setCurrentQuestion(0);
                        setFlaggedQuestions(new Set());
                        setExamType('aptitude');
                    } else {
                        // Fallback to enhanced sample aptitude questions if parsing fails
                        console.error('Failed to parse AI response, using enhanced sample questions');
                        generateEnhancedSampleAptitudeQuestions();
                    }
                } catch (error) {
                    console.error('Error generating aptitude questions with AI:', error);
                    // Fallback to enhanced sample aptitude questions
                    generateEnhancedSampleAptitudeQuestions();
                } finally {
                    setGeneratingQuestions(false);
                }
            };

            // Save questions to JSON file
            const saveQuestionsToJSON = (questions) => {
                try {
                    const storedQuestions = localStorage.getItem('awsExamQuestions');
                    let allQuestions = storedQuestions ? JSON.parse(storedQuestions) : [];

                    // Add new questions
                    allQuestions = [...allQuestions, ...questions];

                    localStorage.setItem('awsExamQuestions', JSON.stringify(allQuestions));
                    console.log('Questions saved to JSON storage');
                } catch (error) {
                    console.error('Error saving questions to JSON:', error);
                }
            };

            // Load questions from JSON file
            const loadQuestionsFromJSON = () => {
                try {
                    const storedQuestions = localStorage.getItem('awsExamQuestions');
                    if (storedQuestions) {
                        const allQuestions = JSON.parse(storedQuestions);
                        return allQuestions;
                    }
                } catch (error) {
                    console.error('Error loading questions from JSON:', error);
                }
                return [];
            };

            // Generate explanation for a question
            const generateExplanation = async (question, options, correctAnswer) => {
                try {
                    const prompt = `Explain why the answer "${correctAnswer}" is correct for the following AWS Cloud Practitioner question in 2-3 short sentences:
                    
                    Question: ${question}
                    
                    Options:
                    ${options.map((opt, idx) => `${String.fromCharCode(65 + idx)}. ${opt}`).join('\n')}
                    
                    Provide a clear, concise explanation focusing on AWS concepts. Keep it short and to the point.`;

                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyCR5TIp-MG3WmAiHZkCPXrKvHVYAMjcsoU', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [
                                {
                                    parts: [
                                        {
                                            text: prompt
                                        }
                                    ]
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to generate explanation');
                    }

                    const data = await response.json();
                    const explanation = data.candidates[0].content.parts[0].text;

                    return explanation;
                } catch (error) {
                    console.error('Error generating explanation:', error);
                    return "Explanation could not be generated at this time. Please try again later.";
                }
            };

            // Show explanation for a question
            const showQuestionExplanation = async (questionIndex) => {
                const question = questions[questionIndex];
                const correctAnswer = answers[questionIndex];

                // Check if we already have the explanation
                if (explanations[questionIndex]) {
                    setCurrentExplanation(explanations[questionIndex]);
                    setShowExplanation(true);
                    return;
                }

                // Generate explanation
                const explanation = await generateExplanation(
                    question.question,
                    question.options,
                    correctAnswer
                );

                // Save explanation
                setExplanations({ ...explanations, [questionIndex]: explanation });
                setCurrentExplanation(explanation);
                setShowExplanation(true);
            };

            // Enhanced Sample Questions with proper multiple selection support
            const generateEnhancedSampleQuestions = () => {
                const sampleQuestions = [
                    {
                        question: "What is the main benefit of cloud computing?",
                        options: [
                            "Increased latency",
                            "On-premises dependency",
                            "Pay-as-you-go pricing",
                            "Manual scalability"
                        ],
                        isMultiSelect: false
                    },
                    {
                        question: "Which AWS service provides global infrastructure?",
                        options: [
                            "S3",
                            "EC2",
                            "AWS Regions and Availability Zones",
                            "IAM"
                        ],
                        isMultiSelect: false
                    },
                    {
                        question: "Which of the following are characteristics of cloud computing? (Choose two)",
                        options: [
                            "On-demand self-service",
                            "Limited scalability",
                            "Resource pooling",
                            "Manual provisioning",
                            "Rapid elasticity"
                        ],
                        isMultiSelect: true
                    },
                    {
                        question: "Which AWS services and features are provided to all customers at no charge? (Choose two)",
                        options: [
                            "Amazon Aurora",
                            "VPC",
                            "Amazon SageMaker",
                            "AWS Identity and Access Management (IAM)",
                            "Amazon Polly"
                        ],
                        isMultiSelect: true
                    },
                    {
                        question: "What are the three pillars of the AWS Well-Architected Framework? (Choose three)",
                        options: [
                            "Operational Excellence",
                            "Security",
                            "Reliability",
                            "Performance Efficiency",
                            "Cost Optimization",
                            "Sustainability"
                        ],
                        isMultiSelect: true
                    }
                ];

                const sampleAnswers = ["C", "C", "A,C", "D,E", "A,B,D"];

                setQuestions(sampleQuestions);
                setAnswers(sampleAnswers);
                
                // NEW: Store current exam for retaking
                setCurrentExamQuestions(sampleQuestions);
                setCurrentExamAnswers(sampleAnswers);
                
                setExamTitle('AWS Cloud Practitioner Exam');
                setPracticeMode(true);
                setExamStarted(true);
                setTimeLeft(300); // 5 minutes for sample
                setUserAnswers({});
                setShowResults(false);
                setCurrentQuestion(0);
                setFlaggedQuestions(new Set());
                setExamType('aws');
            };

            // Enhanced Sample Aptitude Questions with proper multiple selection support
            const generateEnhancedSampleAptitudeQuestions = () => {
                const sampleQuestions = [
                    {
                        question: "If a shirt costs $20 after a 20% discount, what was its original price?",
                        options: [
                            "$24",
                            "$25",
                            "$28",
                            "$30"
                        ],
                        isMultiSelect: false
                    },
                    {
                        question: "Complete the series: 2, 6, 12, 20, ?",
                        options: [
                            "28",
                            "30",
                            "32",
                            "36"
                        ],
                        isMultiSelect: false
                    },
                    {
                        question: "If all roses are flowers and some flowers fade quickly, which statement must be true?",
                        options: [
                            "All roses fade quickly",
                            "Some roses fade quickly",
                            "No roses fade quickly",
                            "Some flowers that fade quickly are roses"
                        ],
                        isMultiSelect: false
                    },
                    {
                        question: "Which of the following numbers are prime? (Choose two)",
                        options: [
                            "15",
                            "17",
                            "21",
                            "23",
                            "27"
                        ],
                        isMultiSelect: true
                    },
                    {
                        question: "Which of the following are valid logical reasoning patterns? (Choose three)",
                        options: [
                            "Deductive reasoning",
                            "Inductive reasoning",
                            "Abductive reasoning",
                            "Reductive reasoning",
                            "Conductive reasoning",
                            "Speculative reasoning"
                        ],
                        isMultiSelect: true
                    }
                ];

                const sampleAnswers = ["B", "B", "D", "B,D", "A,B,C"];

                setQuestions(sampleQuestions);
                setAnswers(sampleAnswers);
                
                // NEW: Store current exam for retaking
                setCurrentExamQuestions(sampleQuestions);
                setCurrentExamAnswers(sampleAnswers);
                
                setExamTitle('Aptitude Practice Test');
                setPracticeMode(true);
                setExamStarted(true);
                setTimeLeft(300); // 5 minutes for sample
                setUserAnswers({});
                setShowResults(false);
                setCurrentQuestion(0);
                setFlaggedQuestions(new Set());
                setExamType('aptitude');
            };

            const handleAnswerSelect = (questionIndex, option) => {
                const question = questions[questionIndex];
                const correctAnswer = answers[questionIndex] || '';

                // Enhanced multi-select detection for PYQ questions
                let isMultipleChoice = question.isMultiSelect;

                // For PYQ questions, detect multi-select based on correct answer format
                if (examType === 'pyq') {
                    // Check if correct answer has multiple options (comma-separated)
                    const correctAnswers = correctAnswer.split(',').map(a => a.trim()).filter(a => a);
                    isMultipleChoice = correctAnswers.length > 1;

                    // Also check if question text indicates multiple selection
                    if (!isMultipleChoice) {
                        const questionText = question.question.toLowerCase();
                        isMultipleChoice = questionText.includes('choose two') ||
                            questionText.includes('choose three') ||
                            questionText.includes('select all') ||
                            questionText.includes('multiple answers') ||
                            questionText.includes('which of the following are') ||
                            questionText.includes('which are') ||
                            questionText.includes('select the') ||
                            questionText.includes('pick the');
                    }

                    // Additional check: if there are more than 4 options, it's likely multi-select
                    if (!isMultipleChoice && question.options && question.options.length > 4) {
                        isMultipleChoice = true;
                    }
                } else {
                    // For other exam types, use existing logic
                    isMultipleChoice = question.isMultiSelect || correctAnswer.split(',').filter(a => a.trim()).length > 1;
                }

                if (isMultipleChoice) {
                    const currentAnswers = userAnswers[questionIndex] ? userAnswers[questionIndex].split(',').map(a => a.trim()).filter(a => a) : [];
                    const optionIndex = currentAnswers.indexOf(option);

                    if (optionIndex > -1) {
                        currentAnswers.splice(optionIndex, 1);
                    } else {
                        currentAnswers.push(option);
                    }

                    const sortedAnswers = currentAnswers.sort().join(',');
                    setUserAnswers({ ...userAnswers, [questionIndex]: sortedAnswers });
                } else {
                    setUserAnswers({ ...userAnswers, [questionIndex]: option });
                }
            };

            const toggleFlag = (questionIndex) => {
                const newFlagged = new Set(flaggedQuestions);
                newFlagged.has(questionIndex) ? newFlagged.delete(questionIndex) : newFlagged.add(questionIndex);
                setFlaggedQuestions(newFlagged);
            };

            const startFullPracticeExam = () => {
                // Use all domains for full practice exam
                setSelectedDomains(awsDomains);
                setQuestionCount(60);
                setDifficulty('medium');
                generateQuestionsWithAI(awsDomains, 60, 'medium', 'full');
            };

            const startDomainPractice = () => {
                if (selectedDomains.length === 0) {
                    alert('Please select at least one domain');
                    return;
                }

                generateQuestionsWithAI(selectedDomains, questionCount, difficulty, 'domain');
            };

            const startServicePractice = () => {
                if (selectedServices.length === 0) {
                    alert('Please select at least one AWS service');
                    return;
                }

                generateServiceWiseQuestions(selectedServices, questionCount, difficulty);
            };

            const startAptitudePractice = () => {
                if (selectedAptitudeTopics.length === 0) {
                    alert('Please select at least one aptitude area');
                    return;
                }

                generateAptitudeQuestions(selectedAptitudeTopics, questionCount, difficulty);
            };

            // NEW: Restart the same exam with the same questions
            const restartSameExam = () => {
                if (currentExamQuestions.length > 0) {
                    setQuestions(currentExamQuestions);
                    setAnswers(currentExamAnswers);
                    setUserAnswers({});
                    setShowResults(false);
                    setExamStarted(true);
                    setCurrentQuestion(0);
                    setFlaggedQuestions(new Set());
                    setScore(0);
                    setShowReview(false);
                    setShowDomainAnalysis(false);
                    
                    // Calculate time based on question count (1.5 minutes per question)
                    const totalTime = currentExamQuestions.length * 90;
                    setTimeLeft(totalTime);
                } else {
                    // Fallback to reset if no current exam is stored
                    resetExam();
                }
            };

            // Calculate domain performance after exam
            const calculateDomainPerformance = () => {
                if (examType !== 'aws') return {};

                const performance = {};

                questions.forEach((q, idx) => {
                    const userAnswer = (userAnswers[idx] || '').trim();
                    const correctAnswer = (answers[idx] || '').trim();

                    const normalizedUserAnswer = userAnswer.split(',').map(a => a.trim()).filter(a => a).sort().join(',');
                    const normalizedCorrectAnswer = correctAnswer.split(',').map(a => a.trim()).filter(a => a).sort().join(',');

                    const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;

                    // Determine which domain this question belongs to
                    let questionDomain = "Unknown";
                    for (const domain of awsDomains) {
                        if (q.question.toLowerCase().includes(domain.name.toLowerCase().split(':')[1]?.trim()) ||
                            domain.topics.some(topic => q.question.toLowerCase().includes(topic.toLowerCase()))) {
                            questionDomain = domain.name;
                            break;
                        }
                    }

                    if (!performance[questionDomain]) {
                        performance[questionDomain] = { correct: 0, total: 0 };
                    }

                    performance[questionDomain].total += 1;
                    if (isCorrect) {
                        performance[questionDomain].correct += 1;
                    }
                });

                return performance;
            };

            const handleSubmit = () => {
                let correct = 0;
                questions.forEach((q, idx) => {
                    const userAnswer = (userAnswers[idx] || '').trim();
                    const correctAnswer = (answers[idx] || '').trim();

                    // Enhanced normalization for multi-select answers
                    const normalizedUserAnswer = userAnswer
                        .split(',')
                        .map(a => a.trim())
                        .filter(a => a)
                        .sort()
                        .join(',')
                        .toUpperCase();

                    const normalizedCorrectAnswer = correctAnswer
                        .split(',')
                        .map(a => a.trim())
                        .filter(a => a)
                        .sort()
                        .join(',')
                        .toUpperCase();

                    console.log(`Question ${idx + 1}:`, {
                        userAnswer,
                        correctAnswer,
                        normalizedUserAnswer,
                        normalizedCorrectAnswer,
                        isEqual: normalizedUserAnswer === normalizedCorrectAnswer
                    });

                    if (normalizedUserAnswer === normalizedCorrectAnswer) {
                        correct++;
                    }
                });

                // Set the score and show results
                setScore(correct);
                setShowResults(true);
                setExamStarted(false);
                setShowConfirmSubmit(false);

                // Calculate domain performance for AWS exams
                const domainPerformanceData = examType === 'aws' ? calculateDomainPerformance() : {};

                const result = {
                    date: new Date().toLocaleString(),
                    score: correct,
                    total: questions.length,
                    percentage: ((correct / questions.length) * 100).toFixed(1),
                    timeSpent: practiceMode ? (questionCount * 90 - timeLeft) : (9000 - timeLeft),
                    examTitle: examTitle,
                    studentName: userName,
                    questions: questions,
                    answers: answers,
                    userAnswers: userAnswers,
                    examType: examType,
                    domainPerformance: domainPerformanceData
                };

                // Save to JSON storage
                saveExamToDatabase(result);

                // Set domain performance for display
                setDomainPerformance(domainPerformanceData);
            };

            const resetExam = () => {
                setUserAnswers({});
                setShowResults(false);
                setExamStarted(false);
                setCurrentQuestion(0);
                setTimeLeft(9000);
                setScore(0);
                setFlaggedQuestions(new Set());
                setShowReview(false);
                setExamTitle('AWS Cloud Practitioner Exam');
                setPracticeMode(false);
                setSelectedDomains([]);
                setSelectedServices([]);
                setQuestionCount(10);
                setDifficulty('medium');
                setDomainPerformance({});
                setShowDomainAnalysis(false);
                setExamType('aws');
                setSelectedAptitudeTopics([]);
                setSelectedPyqSet(null);
                
                // NEW: Clear current exam storage
                setCurrentExamQuestions([]);
                setCurrentExamAnswers([]);
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            useEffect(() => {
                if (examStarted && timeLeft > 0 && !showResults) {
                    const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (timeLeft === 0 && examStarted) {
                    handleSubmit();
                }
            }, [timeLeft, examStarted, showResults]);

            const percentage = questions.length > 0 ? ((score / questions.length) * 100).toFixed(1) : 0;
            const passed = percentage >= 70;
            const answeredCount = Object.keys(userAnswers).filter(key => userAnswers[key]).length;
            const unansweredCount = questions.length - answeredCount;
            const flaggedCount = flaggedQuestions.size;

            const bgClass = darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50';
            const cardClass = darkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';
            const headerClass = darkMode ? 'bg-gradient-to-r from-gray-700 to-gray-900' : 'bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600';

            // Domain Analysis Component (keep existing)
            const DomainAnalysis = () => {
                if (Object.keys(domainPerformance).length === 0) {
                    return (
                        <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                            <h3 className="text-2xl font-bold mb-4">Domain Performance Analysis</h3>
                            <p className="text-center py-4">No domain performance data available for this exam.</p>
                        </div>
                    );
                }

                return (
                    <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                        <h3 className="text-2xl font-bold mb-6">Domain Performance Analysis</h3>
                        <p className="mb-6">Based on your performance, here are the areas you should focus on:</p>

                        <div className="space-y-4">
                            {Object.entries(domainPerformance).map(([domain, data]) => {
                                const domainPercentage = data.total > 0 ? ((data.correct / data.total) * 100).toFixed(1) : 0;
                                const isWeak = domainPercentage < 70;

                                return (
                                    <div key={domain} className={`border rounded-lg p-4 ${isWeak ? 'border-red-200 bg-red-50' : 'border-green-200 bg-green-50'}`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <h4 className="font-bold">{domain}</h4>
                                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${isWeak ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>
                                                {domainPercentage}%
                                            </span>
                                        </div>
                                        <div className="flex justify-between text-sm mb-2">
                                            <span>Correct: {data.correct}/{data.total}</span>
                                            <span>{isWeak ? 'Needs Improvement' : 'Good Performance'}</span>
                                        </div>
                                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                                            <div
                                                className={`h-full ${isWeak ? 'bg-red-500' : 'bg-green-500'} transition-all duration-300`}
                                                style={{ width: `${domainPercentage}%` }}
                                            ></div>
                                        </div>
                                        {isWeak && (
                                            <div className="mt-2 text-sm text-red-600">
                                                <strong>Recommendation:</strong> Focus more on this domain. Review the related topics and practice more questions.
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>

                        <div className="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 className="font-bold text-blue-800 mb-2">Study Recommendations</h4>
                            <ul className="list-disc list-inside text-blue-700 space-y-1">
                                {Object.entries(domainPerformance)
                                    .filter(([domain, data]) => (data.correct / data.total) < 0.7)
                                    .map(([domain, data]) => (
                                        <li key={domain}>Focus on <strong>{domain}</strong> - you scored {((data.correct / data.total) * 100).toFixed(1)}%</li>
                                    ))
                                }
                                {Object.entries(domainPerformance).filter(([domain, data]) => (data.correct / data.total) < 0.7).length === 0 && (
                                    <li>Great job! You're performing well across all domains. Consider taking more challenging practice tests.</li>
                                )}
                            </ul>
                        </div>
                    </div>
                );
            };

            // Fixed Answer Review Component (keep existing)
            const AnswerReview = () => {
                const [expandedQuestions, setExpandedQuestions] = useState(new Set());

                const toggleQuestion = (index) => {
                    const newExpanded = new Set(expandedQuestions);
                    if (newExpanded.has(index)) {
                        newExpanded.delete(index);
                    } else {
                        newExpanded.add(index);
                    }
                    setExpandedQuestions(newExpanded);
                };

                return (
                    <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-bold">Detailed Answer Review</h3>
                            <div className="flex items-center space-x-2">
                                <span className={`px-3 py-1 rounded-full text-sm font-bold ${passed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                    Score: {score}/{questions.length} ({percentage}%)
                                </span>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {questions.map((q, idx) => {
                                const userAns = userAnswers[idx] || 'Not Answered';
                                const correctAns = answers[idx] || '';
                                const userAnswerNorm = userAns.split(',').map(a => a.trim()).filter(a => a).sort().join(',');
                                const correctAnswerNorm = correctAns.split(',').map(a => a.trim()).filter(a => a).sort().join(',');
                                const isCorrect = userAnswerNorm === correctAnswerNorm;
                                const isExpanded = expandedQuestions.has(idx);

                                // Enhanced multi-select detection for PYQ questions in review
                                let isMultiSelect = q.isMultiSelect;
                                if (examType === 'pyq') {
                                    const correctAnswers = correctAns.split(',').map(a => a.trim()).filter(a => a);
                                    isMultiSelect = correctAnswers.length > 1 ||
                                        q.question.toLowerCase().includes('choose two') ||
                                        q.question.toLowerCase().includes('choose three') ||
                                        q.question.toLowerCase().includes('select all') ||
                                        q.question.toLowerCase().includes('multiple answers');
                                } else {
                                    isMultiSelect = q.isMultiSelect || correctAns.includes(',');
                                }

                                return (
                                    <div key={idx} className={`border-2 rounded-lg transition-all duration-300 ${isCorrect
                                        ? 'border-green-500 bg-green-50'
                                        : 'border-red-500 bg-red-50'
                                        }`}>
                                        <div
                                            className="p-4 cursor-pointer hover:bg-opacity-80 transition"
                                            onClick={() => toggleQuestion(idx)}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-3">
                                                    <div className={`w-8 h-8 flex-shrink-0 rounded-full flex items-center justify-center ${isCorrect ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                                                        }`}>
                                                        {isCorrect ? '' : ''}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-semibold text-lg">
                                                            Question {idx + 1}
                                                        </h4>
                                                        <p className="text-sm opacity-75">
                                                            {isCorrect ? 'Correct' : 'Incorrect'} {isMultiSelect && '(Multiple Answers)'}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}>
                                                    
                                                </div>
                                            </div>
                                        </div>

                                        {isExpanded && (
                                            <div className="p-4 border-t border-opacity-50 space-y-4">
                                                <div>
                                                    <h5 className="font-bold text-lg mb-2">Question:</h5>
                                                    <p className="text-gray-700 bg-white p-3 rounded border">{q.question}</p>
                                                </div>

                                                <div>
                                                    <h5 className="font-bold text-lg mb-2">Options:</h5>
                                                    <div className="space-y-2">
                                                        {q.options.map((option, optIdx) => {
                                                            const optionLetter = String.fromCharCode(65 + optIdx);
                                                            const isUserAnswer = userAns.includes(optionLetter);
                                                            const isCorrectAnswer = correctAns.includes(optionLetter);

                                                            return (
                                                                <div
                                                                    key={optIdx}
                                                                    className={`p-3 rounded border-2 transition-all ${isUserAnswer && isCorrectAnswer
                                                                        ? 'border-green-500 bg-green-100'
                                                                        : isUserAnswer && !isCorrectAnswer
                                                                            ? 'border-red-500 bg-red-100'
                                                                            : isCorrectAnswer
                                                                                ? 'border-green-500 bg-green-50'
                                                                                : 'border-gray-300 bg-gray-50'
                                                                        }`}
                                                                >
                                                                    <div className="flex items-center space-x-3">
                                                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isUserAnswer && isCorrectAnswer
                                                                            ? 'border-green-500 bg-green-500 text-white'
                                                                            : isUserAnswer && !isCorrectAnswer
                                                                                ? 'border-red-500 bg-red-500 text-white'
                                                                                : isCorrectAnswer
                                                                                    ? 'border-green-500 text-green-500'
                                                                                    : 'border-gray-400 text-gray-400'
                                                                            }`}>
                                                                            {optionLetter}
                                                                        </div>
                                                                        <span className={isUserAnswer || isCorrectAnswer ? 'font-medium' : ''}>
                                                                            {option}
                                                                        </span>
                                                                        {isUserAnswer && isCorrectAnswer && (
                                                                            <span className="ml-auto text-green-600 font-bold"> Your Answer</span>
                                                                        )}
                                                                        {isUserAnswer && !isCorrectAnswer && (
                                                                            <span className="ml-auto text-red-600 font-bold"> Your Answer</span>
                                                                        )}
                                                                        {!isUserAnswer && isCorrectAnswer && (
                                                                            <span className="ml-auto text-green-600 font-bold"> Correct Answer</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div className={`p-3 rounded ${isCorrect ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300'
                                                        }`}>
                                                        <h6 className="font-semibold mb-1">Your Answer:</h6>
                                                        <p className={isCorrect ? 'text-green-700' : 'text-red-700'}>
                                                            {userAns || 'Not Answered'}
                                                        </p>
                                                    </div>
                                                    <div className="p-3 rounded bg-green-100 border border-green-300">
                                                        <h6 className="font-semibold mb-1">Correct Answer:</h6>
                                                        <p className="text-green-700">{correctAns}</p>
                                                    </div>
                                                </div>

                                                {!isCorrect && (
                                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <h6 className="font-semibold text-blue-800">AI Explanation:</h6>
                                                            <button
                                                                onClick={() => showQuestionExplanation(idx)}
                                                                className="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm flex items-center space-x-1"
                                                            >
                                                                <Brain />
                                                                <span>Show Explanation</span>
                                                            </button>
                                                        </div>
                                                        {explanations[idx] && (
                                                            <p className="text-blue-700 text-sm">{explanations[idx]}</p>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            // History Exam Review Component (keep existing)
            const HistoryExamReview = ({ exam }) => {
                const [expandedQuestions, setExpandedQuestions] = useState(new Set());

                const toggleQuestion = (index) => {
                    const newExpanded = new Set(expandedQuestions);
                    if (newExpanded.has(index)) {
                        newExpanded.delete(index);
                    } else {
                        newExpanded.add(index);
                    }
                    setExpandedQuestions(newExpanded);
                };

                return (
                    <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h3 className="text-2xl font-bold">Previous Exam Review</h3>
                                <p className="text-gray-500">Taken on: {exam.date}</p>
                            </div>
                            <div className="flex items-center space-x-2">
                                <span className={`px-3 py-1 rounded-full text-sm font-bold ${exam.percentage >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }`}>
                                    Score: {exam.score}/{exam.total} ({exam.percentage}%)
                                </span>
                                <button
                                    onClick={() => setSelectedHistoryExam(null)}
                                    className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                                >
                                    Back to History
                                </button>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {exam.questions.map((q, idx) => {
                                const userAns = exam.userAnswers[idx] || 'Not Answered';
                                const correctAns = exam.answers[idx] || '';
                                const userAnswerNorm = userAns.split(',').map(a => a.trim()).filter(a => a).sort().join(',');
                                const correctAnswerNorm = correctAns.split(',').map(a => a.trim()).filter(a => a).sort().join(',');
                                const isCorrect = userAnswerNorm === correctAnswerNorm;
                                const isExpanded = expandedQuestions.has(idx);

                                // Enhanced multi-select detection for PYQ questions in history review
                                let isMultiSelect = q.isMultiSelect;
                                if (exam.examType === 'pyq') {
                                    const correctAnswers = correctAns.split(',').map(a => a.trim()).filter(a => a);
                                    isMultiSelect = correctAnswers.length > 1 ||
                                        q.question.toLowerCase().includes('choose two') ||
                                        q.question.toLowerCase().includes('choose three') ||
                                        q.question.toLowerCase().includes('select all') ||
                                        q.question.toLowerCase().includes('multiple answers');
                                } else {
                                    isMultiSelect = q.isMultiSelect || correctAns.includes(',');
                                }

                                return (
                                    <div key={idx} className={`border-2 rounded-lg transition-all duration-300 ${isCorrect
                                        ? 'border-green-500 bg-green-50'
                                        : 'border-red-500 bg-red-50'
                                        }`}>
                                        <div
                                            className="p-4 cursor-pointer hover:bg-opacity-80 transition"
                                            onClick={() => toggleQuestion(idx)}
                                        >
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-3">
                                                    <div className={`w-8 h-8 flex-shrink-0 rounded-full flex items-center justify-center ${isCorrect ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                                                        }`}>
                                                        {isCorrect ? '' : ''}
                                                    </div>
                                                    <div>
                                                        <h4 className="font-semibold text-lg">
                                                            Question {idx + 1}
                                                        </h4>
                                                        <p className="text-sm opacity-75">
                                                            {isCorrect ? 'Correct' : 'Incorrect'} {isMultiSelect && '(Multiple Answers)'}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}>
                                                    
                                                </div>
                                            </div>
                                        </div>

                                        {isExpanded && (
                                            <div className="p-4 border-t border-opacity-50 space-y-4">
                                                <div>
                                                    <h5 className="font-bold text-lg mb-2">Question:</h5>
                                                    <p className="text-gray-700 bg-white p-3 rounded border">{q.question}</p>
                                                </div>

                                                <div>
                                                    <h5 className="font-bold text-lg mb-2">Options:</h5>
                                                    <div className="space-y-2">
                                                        {q.options.map((option, optIdx) => {
                                                            const optionLetter = String.fromCharCode(65 + optIdx);
                                                            const isUserAnswer = userAns.includes(optionLetter);
                                                            const isCorrectAnswer = correctAns.includes(optionLetter);

                                                            return (
                                                                <div
                                                                    key={optIdx}
                                                                    className={`p-3 rounded border-2 transition-all ${isUserAnswer && isCorrectAnswer
                                                                        ? 'border-green-500 bg-green-100'
                                                                        : isUserAnswer && !isCorrectAnswer
                                                                            ? 'border-red-500 bg-red-100'
                                                                            : isCorrectAnswer
                                                                                ? 'border-green-500 bg-green-50'
                                                                                : 'border-gray-300 bg-gray-50'
                                                                        }`}
                                                                >
                                                                    <div className="flex items-center space-x-3">
                                                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isUserAnswer && isCorrectAnswer
                                                                            ? 'border-green-500 bg-green-500 text-white'
                                                                            : isUserAnswer && !isCorrectAnswer
                                                                                ? 'border-red-500 bg-red-500 text-white'
                                                                                : isCorrectAnswer
                                                                                    ? 'border-green-500 text-green-500'
                                                                                    : 'border-gray-400 text-gray-400'
                                                                            }`}>
                                                                            {optionLetter}
                                                                        </div>
                                                                        <span className={isUserAnswer || isCorrectAnswer ? 'font-medium' : ''}>
                                                                            {option}
                                                                        </span>
                                                                        {isUserAnswer && isCorrectAnswer && (
                                                                            <span className="ml-auto text-green-600 font-bold"> Your Answer</span>
                                                                        )}
                                                                        {isUserAnswer && !isCorrectAnswer && (
                                                                            <span className="ml-auto text-red-600 font-bold"> Your Answer</span>
                                                                        )}
                                                                        {!isUserAnswer && isCorrectAnswer && (
                                                                            <span className="ml-auto text-green-600 font-bold"> Correct Answer</span>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div className={`p-3 rounded ${isCorrect ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300'
                                                        }`}>
                                                        <h6 className="font-semibold mb-1">Your Answer:</h6>
                                                        <p className={isCorrect ? 'text-green-700' : 'text-red-700'}>
                                                            {userAns || 'Not Answered'}
                                                        </p>
                                                    </div>
                                                    <div className="p-3 rounded bg-green-100 border border-green-300">
                                                        <h6 className="font-semibold mb-1">Correct Answer:</h6>
                                                        <p className="text-green-700">{correctAns}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            // PYQ Management Component for Teachers (keep existing)
            const PyqManagement = () => {
                return (
                    <div className="space-y-6">
                        {/* Upload Section */}
                        <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">PYQ Question Management</h3>
                                <button
                                    onClick={() => setShowPyqUpload(true)}
                                    className="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition flex items-center space-x-2"
                                >
                                    <Upload />
                                    <span>Upload Question Sheet</span>
                                </button>
                            </div>

                            <div className="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 className="font-bold text-blue-800 mb-2">Question Sheet Format:</h4>
                                <pre className="text-sm text-blue-700 whitespace-pre-wrap">
                                    {`Topic 1 - Single Topic
Question #1 Topic 1
[Question text here?]
A. Option A
B. Option B
C. Option C
D. Option D
Correct Answer: A
Community vote distribution
A (100%)

Question #2 Topic 1
[Another question?]
A. Option A
B. Option B
C. Option C
D. Option D
E. Option E
Correct Answer: B,C
Community vote distribution
BC (95%)`}
                                </pre>
                            </div>

                            {/* PYQ Sets List */}
                            {pyqQuestions.length > 0 ? (
                                <div>
                                    <h4 className="text-xl font-bold mb-4">Uploaded PYQ Sets</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {pyqQuestions.map((pyqSet, index) => (
                                            <div key={pyqSet.id} className="border rounded-lg p-4 hover:shadow-md transition">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <h5 className="font-bold text-lg">{pyqSet.name}</h5>
                                                        <p className="text-sm text-gray-500">{pyqSet.questionCount} questions</p>
                                                        <p className="text-xs text-gray-400">
                                                            Uploaded: {new Date(pyqSet.uploadedAt).toLocaleDateString()}
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => deletePyqSet(pyqSet.id)}
                                                        className="text-red-500 hover:text-red-700 p-1"
                                                        title="Delete PYQ Set"
                                                    >
                                                        <Trash />
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between text-sm">
                                                        <span>Questions:</span>
                                                        <span className="font-bold">{pyqSet.questionCount}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span>Topics:</span>
                                                        <span className="font-bold">
                                                            {[...new Set(pyqSet.questions.map(q => q.topic))].length}
                                                        </span>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        setSelectedPyqSet(pyqSet);
                                                        setTeacherPyqView('preview');
                                                    }}
                                                    className="w-full mt-3 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition"
                                                >
                                                    Preview Questions
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <p className="text-center text-gray-500 py-8">
                                    No PYQ sets uploaded yet. Click "Upload Question Sheet" to add your first set.
                                </p>
                            )}
                        </div>
                    </div>
                );
            };

            // PYQ Preview Component (keep existing)
            const PyqPreview = () => {
                if (!selectedPyqSet) return null;

                return (
                    <div className="space-y-6">
                        <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                            <div className="flex justify-between items-center mb-6">
                                <div>
                                    <h3 className="text-2xl font-bold">PYQ Set Preview</h3>
                                    <p className="text-gray-500">{selectedPyqSet.name} - {selectedPyqSet.questionCount} questions</p>
                                </div>
                                <button
                                    onClick={() => setTeacherPyqView('manage')}
                                    className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                                >
                                     Back to Management
                                </button>
                            </div>

                            <div className="space-y-4 max-h-96 overflow-y-auto">
                                {selectedPyqSet.questions.map((question, index) => (
                                    <div key={index} className="border rounded-lg p-4">
                                        <div className="flex justify-between items-start mb-3">
                                            <h4 className="font-bold">Question {index + 1}</h4>
                                            <span className="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                                {question.topic}
                                            </span>
                                        </div>
                                        <p className="mb-3">{question.question}</p>
                                        <div className="space-y-2 mb-3">
                                            {question.options.map((option, optIndex) => (
                                                <div key={optIndex} className="flex items-center space-x-2">
                                                    <span className="font-bold w-6">{String.fromCharCode(65 + optIndex)}.</span>
                                                    <span>{option}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="bg-green-50 border border-green-200 rounded p-3">
                                            <span className="font-bold text-green-800">Correct Answer: {question.answer}</span>
                                            {question.isMultiSelect && (
                                                <span className="ml-2 text-green-600 text-sm">(Multiple Answers)</span>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            // PYQ Question Count Selector Component (keep existing)
            const PyqQuestionCountSelector = () => {
                if (!selectedPyqSetForPractice) return null;

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className={`${cardClass} rounded-2xl p-8 max-w-md w-full shadow-2xl`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">Select Question Count</h3>
                                <button
                                    onClick={() => setShowPyqQuestionCountSelector(false)}
                                    className="text-gray-500 hover:text-gray-700 text-2xl"
                                >
                                    
                                </button>
                            </div>

                            <div className="mb-6">
                                <p className="mb-4">
                                    <strong>{selectedPyqSetForPractice.name}</strong> has {selectedPyqSetForPractice.questions.length} total questions.
                                </p>

                                <label className="block text-lg font-semibold mb-3">Number of Questions to Practice:</label>
                                <select
                                    value={pyqQuestionCount}
                                    onChange={(e) => setPyqQuestionCount(parseInt(e.target.value))}
                                    className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                >
                                    <option value={10}>10 Questions</option>
                                    <option value={30}>30 Questions</option>
                                    <option value={50}>50 Questions</option>
                                    <option value={60}>60 Questions</option>
                                    <option value={selectedPyqSetForPractice.questions.length}>All Questions ({selectedPyqSetForPractice.questions.length})</option>
                                </select>
                            </div>

                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                <h4 className="font-bold text-yellow-800 mb-2">Features:</h4>
                                <ul className="text-sm text-yellow-700 space-y-1">
                                    <li> Questions will be shuffled randomly</li>
                                    <li> 15% of questions will be Multiple Select (MSQ)</li>
                                    <li> MSQ questions support 2-4 correct answers</li>
                                    <li> AI explanations available in review mode</li>
                                </ul>
                            </div>

                            <div className="flex justify-end space-x-4">
                                <button
                                    onClick={() => setShowPyqQuestionCountSelector(false)}
                                    className="px-6 py-3 bg-gray-500 text-white rounded-xl font-bold hover:bg-gray-600 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={() => startPyqPractice(selectedPyqSetForPractice)}
                                    className="px-6 py-3 bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                >
                                    Start Practice
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Teacher Dashboard Components (keep existing)
            const TeacherDashboard = () => {
                const [selectedStudent, setSelectedStudent] = useState(null);
                const [studentExamHistory, setStudentExamHistory] = useState([]);

                const loadStudentDetails = (student) => {
                    setSelectedStudent(student);

                    try {
                        const storedResults = localStorage.getItem('awsExamResults');
                        if (storedResults) {
                            const allResults = JSON.parse(storedResults);
                            const studentResults = allResults.filter(result => result.studentName === student.name);
                            setStudentExamHistory(studentResults);
                        } else {
                            setStudentExamHistory([]);
                        }
                    } catch (error) {
                        console.error('Error loading student details:', error);
                    }
                };

                // Calculate student stats
                const getStudentStats = (studentName) => {
                    try {
                        const storedResults = localStorage.getItem('awsExamResults');
                        if (storedResults) {
                            const allResults = JSON.parse(storedResults);
                            const studentResults = allResults.filter(result => result.studentName === studentName);

                            if (studentResults.length === 0) {
                                return { examCount: 0, avgScore: 0, bestScore: 0 };
                            }

                            const examCount = studentResults.length;
                            const avgScore = studentResults.reduce((sum, result) => sum + parseFloat(result.percentage), 0) / examCount;
                            const bestScore = Math.max(...studentResults.map(result => parseFloat(result.percentage)));

                            return {
                                examCount,
                                avgScore: Math.round(avgScore),
                                bestScore: Math.round(bestScore)
                            };
                        }
                    } catch (error) {
                        console.error('Error calculating student stats:', error);
                    }

                    return { examCount: 0, avgScore: 0, bestScore: 0 };
                };

                return (
                    <div className="space-y-6">
                        {/* Navigation Tabs */}
                        <div className={`${cardClass} rounded-2xl p-4 shadow-lg`}>
                            <div className="flex space-x-4">
                                <button
                                    onClick={() => setTeacherView('dashboard')}
                                    className={`px-4 py-2 rounded-lg font-bold transition ${teacherView === 'dashboard' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'}`}
                                >
                                    Students Overview
                                </button>
                                <button
                                    onClick={() => setTeacherView('pyq-management')}
                                    className={`px-4 py-2 rounded-lg font-bold transition ${teacherView === 'pyq-management' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'}`}
                                >
                                    PYQ Management
                                </button>
                            </div>
                        </div>

                        {/* Students Overview */}
                        {teacherView === 'dashboard' && (
                            <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                                <h3 className="text-2xl font-bold mb-6">Students Overview</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {allStudents.map((student, index) => {
                                        const stats = getStudentStats(student.name);

                                        return (
                                            <div key={index} className="border rounded-lg p-4 hover:shadow-md transition">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div>
                                                        <h4 className="font-bold text-lg">{student.name}</h4>
                                                        <p className="text-sm text-gray-500 capitalize">{student.role}</p>
                                                        <p className="text-xs text-gray-400">
                                                            Joined: {new Date(student.createdAt).toLocaleDateString()}
                                                        </p>
                                                    </div>
                                                    <button
                                                        onClick={() => deleteStudent(student.name)}
                                                        className="text-red-500 hover:text-red-700 p-1"
                                                        title="Delete Student"
                                                    >
                                                        <Trash />
                                                    </button>
                                                </div>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between text-sm">
                                                        <span>Exams Taken:</span>
                                                        <span className="font-bold">{stats.examCount}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span>Average Score:</span>
                                                        <span className={`font-bold ${stats.avgScore >= 70 ? 'text-green-600' : 'text-red-600'
                                                            }`}>
                                                            {stats.avgScore}%
                                                        </span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span>Best Score:</span>
                                                        <span className={`font-bold ${stats.bestScore >= 70 ? 'text-green-600' : 'text-red-600'
                                                            }`}>
                                                            {stats.bestScore}%
                                                        </span>
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        loadStudentDetails(student);
                                                        setTeacherView('student-details');
                                                    }}
                                                    className="w-full mt-3 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition"
                                                >
                                                    View Details
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* PYQ Management */}
                        {teacherView === 'pyq-management' && (
                            <>
                                {teacherPyqView === 'manage' && <PyqManagement />}
                                {teacherPyqView === 'preview' && <PyqPreview />}
                            </>
                        )}

                        {/* Student Details View */}
                        {teacherView === 'student-details' && selectedStudent && (
                            <div className="space-y-6">
                                <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                                    <div className="flex justify-between items-center mb-6">
                                        <div>
                                            <h3 className="text-2xl font-bold">{selectedStudent.name}'s Exam History</h3>
                                            <p className="text-gray-500">Role: {selectedStudent.role}</p>
                                        </div>
                                        <button
                                            onClick={() => setTeacherView('dashboard')}
                                            className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition"
                                        >
                                             Back to Students
                                        </button>
                                    </div>

                                    {studentExamHistory.length > 0 ? (
                                        <div className="space-y-4">
                                            {studentExamHistory.map((exam, index) => (
                                                <div key={index} className="border rounded-lg p-4 hover:shadow-md transition">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <div>
                                                            <h4 className="font-bold text-lg">{exam.examTitle}</h4>
                                                            <p className="text-sm text-gray-500">{new Date(exam.dateCreated).toLocaleString()}</p>
                                                            <p className="text-xs text-blue-500 capitalize">{exam.examType || 'aws'} exam</p>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${exam.percentage >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                                }`}>
                                                                {exam.score}/{exam.totalQuestions} ({exam.percentage}%)
                                                            </span>
                                                            <button
                                                                onClick={() => deleteExamResult(exam.id)}
                                                                className="text-red-500 hover:text-red-700 p-1"
                                                                title="Delete Exam Result"
                                                            >
                                                                <Trash />
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center space-x-4 text-sm">
                                                        <span className="flex items-center space-x-1">
                                                            <Clock />
                                                            <span>{formatTime(exam.timeSpent)}</span>
                                                        </span>
                                                        <span className={`px-2 py-1 rounded ${exam.percentage >= 70 ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                                                            }`}>
                                                            {exam.percentage >= 70 ? 'PASS' : 'FAIL'}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-center text-gray-500 py-8">
                                            No exam history available for {selectedStudent.name}
                                        </p>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            // Domain Selector Component (keep existing)
            const DomainSelector = () => {
                const toggleDomain = (domain) => {
                    if (selectedDomains.includes(domain)) {
                        setSelectedDomains(selectedDomains.filter(d => d !== domain));
                    } else {
                        setSelectedDomains([...selectedDomains, domain]);
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                        <div className={`${cardClass} rounded-2xl p-8 max-w-2xl w-full shadow-2xl my-8`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">Select Domains for Practice</h3>
                                <button onClick={() => setShowDomainSelector(false)} className="text-gray-500 hover:text-gray-700 text-2xl"></button>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">Number of Questions</label>
                                <select
                                    value={questionCount}
                                    onChange={(e) => setQuestionCount(parseInt(e.target.value))}
                                    className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                >
                                    <option value={10}>10 Questions</option>
                                    <option value={20}>20 Questions</option>
                                    <option value={30}>30 Questions</option>
                                    <option value={40}>40 Questions</option>
                                    <option value={50}>50 Questions</option>
                                </select>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">Difficulty Level</label>
                                <select
                                    value={difficulty}
                                    onChange={(e) => setDifficulty(e.target.value)}
                                    className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                >
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">AWS Domains</label>
                                <div className="space-y-3 max-h-64 overflow-y-auto">
                                    {awsDomains.map((domain, index) => (
                                        <div key={index} className="border rounded-lg overflow-hidden">
                                            <button
                                                onClick={() => toggleDomain(domain)}
                                                className={`w-full p-4 text-left transition ${selectedDomains.includes(domain)
                                                    ? 'bg-blue-500 text-white'
                                                    : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                                                    }`}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <span className="font-semibold">{domain.name}</span>
                                                    {selectedDomains.includes(domain) && (
                                                        <div className="w-6 h-6 bg-white text-blue-500 rounded-full flex items-center justify-center">
                                                            
                                                        </div>
                                                    )}
                                                </div>
                                            </button>
                                            {selectedDomains.includes(domain) && (
                                                <div className="p-3 bg-blue-50 border-t">
                                                    <p className="text-sm text-blue-800 font-medium">Topics included:</p>
                                                    <p className="text-xs text-blue-600">{domain.topics.slice(0, 3).join(', ')}...</p>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex justify-end space-x-4">
                                <button
                                    onClick={() => setShowDomainSelector(false)}
                                    className="px-6 py-3 bg-gray-500 text-white rounded-xl font-bold hover:bg-gray-600 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={() => {
                                        setShowDomainSelector(false);
                                        startDomainPractice();
                                    }}
                                    disabled={selectedDomains.length === 0 || generatingQuestions}
                                    className="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center space-x-2"
                                >
                                    {generatingQuestions ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>Generating...</span>
                                        </>
                                    ) : (
                                        <>
                                            <Zap />
                                            <span>Start Practice</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Service Selector Component (NEW)
            const ServiceSelector = () => {
                const toggleService = (service) => {
                    if (selectedServices.includes(service)) {
                        setSelectedServices(selectedServices.filter(s => s !== service));
                    } else {
                        setSelectedServices([...selectedServices, service]);
                    }
                };

                const toggleCategory = (category) => {
                    const categoryServices = awsServices.find(c => c.category === category)?.services || [];
                    const allSelected = categoryServices.every(service => selectedServices.includes(service));

                    if (allSelected) {
                        // Deselect all services in this category
                        setSelectedServices(selectedServices.filter(service => !categoryServices.includes(service)));
                    } else {
                        // Select all services in this category
                        const newServices = [...selectedServices];
                        categoryServices.forEach(service => {
                            if (!newServices.includes(service)) {
                                newServices.push(service);
                            }
                        });
                        setSelectedServices(newServices);
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                        <div className={`${cardClass} rounded-2xl p-8 max-w-4xl w-full shadow-2xl my-8`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">Select AWS Services for Practice</h3>
                                <button onClick={() => setShowServiceSelector(false)} className="text-gray-500 hover:text-gray-700 text-2xl"></button>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">Number of Questions</label>
                                <select
                                    value={questionCount}
                                    onChange={(e) => setQuestionCount(parseInt(e.target.value))}
                                    className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                >
                                    <option value={10}>10 Questions</option>
                                    <option value={20}>20 Questions</option>
                                    <option value={30}>30 Questions</option>
                                    <option value={40}>40 Questions</option>
                                    <option value={50}>50 Questions</option>
                                </select>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">Difficulty Level</label>
                                <select
                                    value={difficulty}
                                    onChange={(e) => setDifficulty(e.target.value)}
                                    className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                >
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">AWS Services</label>
                                <div className="space-y-4 max-h-96 overflow-y-auto">
                                    {awsServices.map((category, index) => {
                                        const categoryServices = category.services;
                                        const allSelected = categoryServices.every(service => selectedServices.includes(service));
                                        const someSelected = categoryServices.some(service => selectedServices.includes(service));

                                        return (
                                            <div key={index} className="border rounded-lg overflow-hidden">
                                                <button
                                                    onClick={() => toggleCategory(category.category)}
                                                    className={`w-full p-4 text-left transition ${allSelected
                                                        ? 'bg-purple-500 text-white'
                                                        : someSelected
                                                            ? 'bg-purple-300 text-purple-800'
                                                            : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                                                        }`}
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <span className="font-semibold">{category.category}</span>
                                                        <div className="flex items-center space-x-2">
                                                            <span className="text-sm">
                                                                {categoryServices.filter(service => selectedServices.includes(service)).length}/{categoryServices.length} selected
                                                            </span>
                                                            <div className={`w-6 h-6 rounded-full flex items-center justify-center ${allSelected ? 'bg-white text-purple-500' : someSelected ? 'bg-purple-500 text-white' : 'border-2 border-gray-400'}`}>
                                                                {allSelected ? '' : someSelected ? '' : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </button>
                                                <div className="p-3 bg-gray-50 border-t">
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                        {categoryServices.map((service, serviceIndex) => (
                                                            <button
                                                                key={serviceIndex}
                                                                onClick={() => toggleService(service)}
                                                                className={`p-2 rounded text-left text-sm transition ${selectedServices.includes(service)
                                                                    ? 'bg-blue-100 text-blue-800 border border-blue-300'
                                                                    : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50'
                                                                    }`}
                                                            >
                                                                <div className="flex items-center space-x-2">
                                                                    <div className={`w-4 h-4 rounded border flex items-center justify-center ${selectedServices.includes(service) ? 'bg-blue-500 border-blue-500' : 'border-gray-400'}`}>
                                                                        {selectedServices.includes(service) && <span className="text-white text-xs"></span>}
                                                                    </div>
                                                                    <span className="truncate">{service}</span>
                                                                </div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="flex justify-end space-x-4">
                                <button
                                    onClick={() => setShowServiceSelector(false)}
                                    className="px-6 py-3 bg-gray-500 text-white rounded-xl font-bold hover:bg-gray-600 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={() => {
                                        setShowServiceSelector(false);
                                        startServicePractice();
                                    }}
                                    disabled={selectedServices.length === 0 || generatingQuestions}
                                    className="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center space-x-2"
                                >
                                    {generatingQuestions ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>Generating...</span>
                                        </>
                                    ) : (
                                        <>
                                            <Server />
                                            <span>Start Practice</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Aptitude Selector Component (keep existing)
            const AptitudeSelector = () => {
                const toggleTopic = (topic) => {
                    if (selectedAptitudeTopics.includes(topic)) {
                        setSelectedAptitudeTopics(selectedAptitudeTopics.filter(t => t !== topic));
                    } else {
                        setSelectedAptitudeTopics([...selectedAptitudeTopics, topic]);
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                        <div className={`${cardClass} rounded-2xl p-8 max-w-2xl w-full shadow-2xl my-8`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">Select Aptitude Areas</h3>
                                <button onClick={() => setShowAptitudeSelector(false)} className="text-gray-500 hover:text-gray-700 text-2xl"></button>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">Number of Questions</label>
                                <select
                                    value={questionCount}
                                    onChange={(e) => setQuestionCount(parseInt(e.target.value))}
                                    className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                >
                                    <option value={10}>10 Questions</option>
                                    <option value={20}>20 Questions</option>
                                    <option value={30}>30 Questions</option>
                                    <option value={40}>40 Questions</option>
                                    <option value={50}>50 Questions</option>
                                </select>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">Difficulty Level</label>
                                <select
                                    value={difficulty}
                                    onChange={(e) => setDifficulty(e.target.value)}
                                    className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                >
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">Aptitude Areas</label>
                                <div className="space-y-3 max-h-64 overflow-y-auto">
                                    {aptitudeTopics.map((topic, index) => (
                                        <div key={index} className="border rounded-lg overflow-hidden">
                                            <button
                                                onClick={() => toggleTopic(topic)}
                                                className={`w-full p-4 text-left transition ${selectedAptitudeTopics.includes(topic)
                                                    ? 'bg-purple-500 text-white'
                                                    : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                                                    }`}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <span className="font-semibold">{topic.name}</span>
                                                    {selectedAptitudeTopics.includes(topic) && (
                                                        <div className="w-6 h-6 bg-white text-purple-500 rounded-full flex items-center justify-center">
                                                            
                                                        </div>
                                                    )}
                                                </div>
                                            </button>
                                            {selectedAptitudeTopics.includes(topic) && (
                                                <div className="p-3 bg-purple-50 border-t">
                                                    <p className="text-sm text-purple-800 font-medium">Topics included:</p>
                                                    <p className="text-xs text-purple-600">{topic.topics.slice(0, 3).join(', ')}...</p>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex justify-end space-x-4">
                                <button
                                    onClick={() => setShowAptitudeSelector(false)}
                                    className="px-6 py-3 bg-gray-500 text-white rounded-xl font-bold hover:bg-gray-600 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={() => {
                                        setShowAptitudeSelector(false);
                                        startAptitudePractice();
                                    }}
                                    disabled={selectedAptitudeTopics.length === 0 || generatingQuestions}
                                    className="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center space-x-2"
                                >
                                    {generatingQuestions ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>Generating...</span>
                                        </>
                                    ) : (
                                        <>
                                            <Calculator />
                                            <span>Start Practice</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Question Generator Component (keep existing)
            const QuestionGenerator = () => {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                        <div className={`${cardClass} rounded-2xl p-8 max-w-2xl w-full shadow-2xl my-8`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">Custom Practice Test</h3>
                                <button onClick={() => setShowQuestionGenerator(false)} className="text-gray-500 hover:text-gray-700 text-2xl"></button>
                            </div>

                            <div className="mb-6">
                                <p className="mb-4">Generate custom AWS Cloud Practitioner questions using AI. Select domains, difficulty, and number of questions.</p>

                                <div className="mb-6">
                                    <label className="block text-lg font-semibold mb-3">Number of Questions</label>
                                    <select
                                        value={questionCount}
                                        onChange={(e) => setQuestionCount(parseInt(e.target.value))}
                                        className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                    >
                                        <option value={10}>10 Questions</option>
                                        <option value={20}>20 Questions</option>
                                        <option value={30}>30 Questions</option>
                                        <option value={40}>40 Questions</option>
                                        <option value={50}>50 Questions</option>
                                    </select>
                                </div>

                                <div className="mb-6">
                                    <label className="block text-lg font-semibold mb-3">Difficulty Level</label>
                                    <select
                                        value={difficulty}
                                        onChange={(e) => setDifficulty(e.target.value)}
                                        className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                    >
                                        <option value="easy">Easy</option>
                                        <option value="medium">Medium</option>
                                        <option value="hard">Hard</option>
                                    </select>
                                </div>

                                <div className="mb-6">
                                    <label className="block text-lg font-semibold mb-3">AWS Domains</label>
                                    <div className="space-y-3 max-h-64 overflow-y-auto">
                                        {awsDomains.map((domain, index) => (
                                            <div key={index} className="border rounded-lg overflow-hidden">
                                                <button
                                                    onClick={() => {
                                                        if (selectedDomains.includes(domain)) {
                                                            setSelectedDomains(selectedDomains.filter(d => d !== domain));
                                                        } else {
                                                            setSelectedDomains([...selectedDomains, domain]);
                                                        }
                                                    }}
                                                    className={`w-full p-4 text-left transition ${selectedDomains.includes(domain)
                                                        ? 'bg-blue-500 text-white'
                                                        : darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                                                        }`}
                                                >
                                                    <div className="flex items-center justify-between">
                                                        <span className="font-semibold">{domain.name}</span>
                                                        {selectedDomains.includes(domain) && (
                                                            <div className="w-6 h-6 bg-white text-blue-500 rounded-full flex items-center justify-center">
                                                                
                                                            </div>
                                                        )}
                                                    </div>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-end space-x-4">
                                <button
                                    onClick={() => setShowQuestionGenerator(false)}
                                    className="px-6 py-3 bg-gray-500 text-white rounded-xl font-bold hover:bg-gray-600 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={() => {
                                        setShowQuestionGenerator(false);
                                        generateQuestionsWithAI(selectedDomains, questionCount, difficulty, 'custom');
                                    }}
                                    disabled={selectedDomains.length === 0 || generatingQuestions}
                                    className="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center space-x-2"
                                >
                                    {generatingQuestions ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>Generating...</span>
                                        </>
                                    ) : (
                                        <>
                                            <Brain />
                                            <span>Generate Questions</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // PYQ Upload Component (keep existing)
            const PyqUpload = () => {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                        <div className={`${cardClass} rounded-2xl p-8 max-w-4xl w-full shadow-2xl my-8`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">Upload PYQ Question Sheet</h3>
                                <button onClick={() => setShowPyqUpload(false)} className="text-gray-500 hover:text-gray-700 text-2xl"></button>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold mb-3">Question Sheet Text</label>
                                <textarea
                                    value={pyqQuestionFile}
                                    onChange={(e) => setPyqQuestionFile(e.target.value)}
                                    placeholder={`Paste your question sheet here in the format:

Topic 1 - Cloud Concepts
Question #1 Topic 1
What is the main benefit of cloud computing?
A. Increased latency
B. On-premises dependency
C. Pay-as-you-go pricing
D. Manual scalability
Correct Answer: C
Community vote distribution
C (100%)

Question #2 Topic 1
Which AWS service provides global infrastructure?
A. S3
B. EC2
C. AWS Regions and Availability Zones
D. IAM
E. Amazon CloudFront
Correct Answer: C
Community vote distribution
C (98%)`}
                                    rows={20}
                                    className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition font-mono text-sm`}
                                />
                            </div>

                            <div className="flex justify-end space-x-4">
                                <button
                                    onClick={() => setShowPyqUpload(false)}
                                    className="px-6 py-3 bg-gray-500 text-white rounded-xl font-bold hover:bg-gray-600 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handlePyqUpload}
                                    disabled={!pyqQuestionFile.trim()}
                                    className="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                >
                                    Upload Questions
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // PYQ Practice Selector Component (keep existing)
            const PyqPracticeSelector = () => {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                        <div className={`${cardClass} rounded-2xl p-8 max-w-4xl w-full shadow-2xl my-8`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">PYQ Practice Sets</h3>
                                <button onClick={() => setShowPyqPractice(false)} className="text-gray-500 hover:text-gray-700 text-2xl"></button>
                            </div>

                            {pyqQuestions.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {pyqQuestions.map((pyqSet, index) => (
                                        <div key={pyqSet.id} className="border rounded-lg p-4 hover:shadow-md transition">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <h4 className="font-bold text-lg">{pyqSet.name}</h4>
                                                    <p className="text-sm text-gray-500">{pyqSet.questionCount} questions</p>
                                                    <p className="text-xs text-gray-400">
                                                        Uploaded: {new Date(pyqSet.uploadedAt).toLocaleDateString()}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span>Questions:</span>
                                                    <span className="font-bold">{pyqSet.questionCount}</span>
                                                </div>
                                                <div className="flex justify-between text-sm">
                                                    <span>Topics:</span>
                                                    <span className="font-bold">
                                                        {[...new Set(pyqSet.questions.map(q => q.topic))].length}
                                                    </span>
                                                </div>
                                                <div className="flex justify-between text-sm">
                                                    <span>MSQ Questions:</span>
                                                    <span className="font-bold text-purple-600">
                                                        {pyqSet.questions.filter(q => q.isMultiSelect).length} ({Math.round((pyqSet.questions.filter(q => q.isMultiSelect).length / pyqSet.questionCount) * 100)}%)
                                                    </span>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    setSelectedPyqSetForPractice(pyqSet);
                                                    setShowPyqQuestionCountSelector(true);
                                                }}
                                                className="w-full mt-3 bg-gradient-to-r from-teal-500 to-teal-600 text-white py-2 rounded-lg hover:shadow-xl transform hover:scale-105 transition"
                                            >
                                                Start Practice
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-8">
                                    <div className="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                                        <FileText />
                                    </div>
                                    <h4 className="text-xl font-bold mb-2">No PYQ Sets Available</h4>
                                    <p className="text-gray-500 mb-4">No previous year question sets have been uploaded yet.</p>
                                    <p className="text-sm text-gray-400">Teachers can upload question sets in the teacher dashboard.</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            // Explanation Modal (keep existing)
            const ExplanationModal = () => {
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className={`${cardClass} rounded-2xl p-8 max-w-2xl w-full shadow-2xl`}>
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-2xl font-bold">AI Explanation</h3>
                                <button onClick={() => setShowExplanation(false)} className="text-gray-500 hover:text-gray-700 text-2xl"></button>
                            </div>

                            <div className="mb-6">
                                <p className="text-lg">{currentExplanation}</p>
                            </div>

                            <div className="flex justify-end">
                                <button
                                    onClick={() => setShowExplanation(false)}
                                    className="px-6 py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Login Handler (keep existing)
            const handleLogin = (role) => {
                if (userName.trim()) {
                    // Save student to JSON storage
                    if (saveStudentToDatabase(userName, role)) {
                        setUserRole(role);
                        if (role === 'student') {
                            loadStudentExamHistory();
                        } else {
                            loadAllStudents();
                        }
                    }
                }
            };

            // Login Screen (keep existing)
            if (!userRole) {
                return (
                    <div className={`min-h-screen ${bgClass} flex items-center justify-center p-4 transition-all duration-500`}>
                        <div className={`${cardClass} rounded-3xl shadow-2xl p-8 max-w-md w-full transform hover:scale-105 transition-all duration-300`}>
                            <div className="text-center mb-8">
                                <div className="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center animate-pulse">
                                    <div className="w-12 h-12 text-white"><BookOpen /></div>
                                </div>
                                <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
                                    AWS AI Exam Portal
                                </h1>
                                <p className={darkMode ? 'text-gray-400' : 'text-gray-500'}>AI-Powered AWS Cloud Practitioner Certification Platform</p>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">Your Name</label>
                                    <input
                                        type="text"
                                        value={userName}
                                        onChange={(e) => setUserName(e.target.value)}
                                        placeholder="Soham Santosh Pawar"
                                        className={`w-full px-4 py-3 rounded-lg border-2 ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'} focus:border-blue-500 outline-none transition`}
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <button
                                        onClick={() => handleLogin('student')}
                                        disabled={!userName.trim()}
                                        className="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    >
                                        <div className="flex flex-col items-center space-y-2">
                                            <div className="w-8 h-8"><User /></div>
                                            <span>Student</span>
                                        </div>
                                    </button>
                                    <button
                                        onClick={() => handleLogin('teacher')}
                                        disabled={!userName.trim()}
                                        className="bg-gradient-to-r from-purple-500 to-purple-600 text-white py-4 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    >
                                        <div className="flex flex-col items-center space-y-2">
                                            <div className="w-8 h-8"><Users /></div>
                                            <span>Teacher</span>
                                        </div>
                                    </button>
                                </div>
                            </div>

                            <div className="mt-6 text-center">
                                <button onClick={() => setDarkMode(!darkMode)} className={`px-4 py-2 rounded-lg font-medium transition transform hover:scale-105 ${darkMode ? 'bg-yellow-500 text-gray-900' : 'bg-gray-800 text-white'}`}>
                                    {darkMode ? ' Light Mode' : ' Dark Mode'}
                                </button>
                            </div>

                            <div className="mt-4 text-center">
                                <div className="flex items-center justify-center space-x-2 text-green-600">
                                    <Database />
                                    <span className="text-sm">JSON Storage Ready</span>
                                    <span className="text-sm">
                                        Developed By @ <a
                                            href="https://www.linkedin.com/in/sohampawar7030/"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="text-blue-500 hover:underline"
                                        >
                                            Soham Pawar
                                        </a>
                                    </span>

                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Teacher Dashboard (keep existing)
            if (userRole === 'teacher') {
                return (
                    <div className={`min-h-screen ${bgClass} transition-colors duration-300`}>
                        <div className={`${headerClass} text-white shadow-lg`}>
                            <div className="max-w-7xl mx-auto px-4 py-4">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center space-x-4">
                                        <div className="w-10 h-10"><Users /></div>
                                        <div>
                                            <h1 className="text-2xl font-bold">Teacher Dashboard</h1>
                                            <p className="text-sm text-blue-100">Welcome, {userName}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-4">
                                        <div className="flex items-center space-x-2 text-green-400">
                                            <Database />
                                            <span className="text-sm">{allStudents.length} Students</span>
                                        </div>
                                        <button onClick={() => setDarkMode(!darkMode)} className="px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition">
                                            {darkMode ? '' : ''}
                                        </button>
                                        <button onClick={() => setUserRole(null)} className="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 transition flex items-center space-x-2">
                                            <div className="w-5 h-5"><User /></div>
                                            <span>Logout</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <TeacherDashboard />
                        </div>
                    </div>
                );
            }

            // Student Interface - Show History Exam Review if selected (keep existing)
            if (selectedHistoryExam) {
                return (
                    <div className={`min-h-screen ${bgClass} transition-colors duration-300`}>
                        <div className={`${headerClass} text-white shadow-lg`}>
                            <div className="max-w-7xl mx-auto px-4 py-4">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center space-x-4">
                                        <div className="w-10 h-10"><History /></div>
                                        <div>
                                            <h1 className="text-2xl font-bold">Exam History Review</h1>
                                            <p className="text-sm text-blue-100">Welcome back, {userName}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-4">
                                        <button onClick={() => setDarkMode(!darkMode)} className="px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition">
                                            {darkMode ? '' : ''}
                                        </button>
                                        <button onClick={() => setSelectedHistoryExam(null)} className="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 transition flex items-center space-x-2">
                                            <div className="w-5 h-5"><User /></div>
                                            <span>Back to Current</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <HistoryExamReview exam={selectedHistoryExam} />
                        </div>
                    </div>
                );
            }

            // Student Interface - Normal View
            return (
                <div className={`min-h-screen ${bgClass} transition-colors duration-300`}>
                    <div className={`${headerClass} text-white shadow-lg`}>
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center space-x-4">
                                    <div className="w-10 h-10"><BookOpen /></div>
                                    <div>
                                        <h1 className="text-2xl font-bold">{examTitle}</h1>
                                        <p className="text-sm text-blue-100">Welcome, {userName}</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    {examStarted && (
                                        <div className={`px-4 py-2 rounded-lg font-bold flex items-center space-x-2 ${timeLeft < 300 ? 'bg-red-500 animate-pulse' : 'bg-white bg-opacity-20'}`}>
                                            <div className="w-5 h-5"><Clock /></div>
                                            <span>{formatTime(timeLeft)}</span>
                                        </div>
                                    )}
                                    <button onClick={() => setShowStats(!showStats)} className="px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition flex items-center space-x-2">
                                        <div className="w-5 h-5"><History /></div>
                                        <span>History ({examHistory.length})</span>
                                    </button>
                                    <button onClick={() => setDarkMode(!darkMode)} className="px-4 py-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 transition">
                                        {darkMode ? '' : ''}
                                    </button>
                                    <button onClick={() => setUserRole(null)} className="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 transition flex items-center space-x-2">
                                        <div className="w-5 h-5"><User /></div>
                                        <span>Logout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-6">
                        {!examStarted && !showResults ? (
                            <div className="space-y-6">
                                {/* Main Dashboard Card */}
                                <div className={`${cardClass} rounded-3xl shadow-2xl p-8 max-w-4xl mx-auto`}>
                                    <div className="text-center mb-8">
                                        <div className="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                            <div className="w-12 h-12 text-white"><Brain /></div>
                                        </div>
                                        <h2 className="text-3xl font-bold mb-2">AWS Cloud Practitioner AI Learning Platform</h2>
                                        <p className="opacity-75">AI-powered practice tests and explanations to help you pass the AWS exam</p>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className={`p-6 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-blue-50'} border-2 border-blue-200`}>
                                            <div className="flex items-center space-x-3 mb-4">
                                                <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                                    <div className="w-6 h-6 text-white"><Target /></div>
                                                </div>
                                                <h3 className="text-xl font-bold">Domain-Wise Practice</h3>
                                            </div>
                                            <p className="mb-4">Practice specific AWS domains with AI-generated questions tailored to your needs.</p>
                                            <button
                                                onClick={() => setShowDomainSelector(true)}
                                                className="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                            >
                                                Start Domain Practice
                                            </button>
                                        </div>

                                        <div className={`p-6 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-purple-50'} border-2 border-purple-200`}>
                                            <div className="flex items-center space-x-3 mb-4">
                                                <div className="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                                                    <div className="w-6 h-6 text-white"><Server /></div>
                                                </div>
                                                <h3 className="text-xl font-bold">Service-Wise Practice</h3>
                                            </div>
                                            <p className="mb-4">Practice specific AWS services with AI-generated questions covering all exam services.</p>
                                            <button
                                                onClick={() => setShowServiceSelector(true)}
                                                className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                            >
                                                Start Service Practice
                                            </button>
                                        </div>

                                        <div className={`p-6 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-green-50'} border-2 border-green-200`}>
                                            <div className="flex items-center space-x-3 mb-4">
                                                <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                                    <div className="w-6 h-6 text-white"><BookOpen /></div>
                                                </div>
                                                <h3 className="text-xl font-bold">Full Practice Exam</h3>
                                            </div>
                                            <p className="mb-4">Take a full-length AWS Cloud Practitioner practice exam with 60 questions and timed conditions.</p>
                                            <button
                                                onClick={startFullPracticeExam}
                                                disabled={generatingQuestions}
                                                className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                            >
                                                {generatingQuestions ? (
                                                    <div className="flex items-center justify-center space-x-2">
                                                        <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                        <span>Generating...</span>
                                                    </div>
                                                ) : (
                                                    "Start Full Exam (60 Questions)"
                                                )}
                                            </button>
                                        </div>

                                        <div className={`p-6 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-orange-50'} border-2 border-orange-200`}>
                                            <div className="flex items-center space-x-3 mb-4">
                                                <div className="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                                                    <div className="w-6 h-6 text-white"><Zap /></div>
                                                </div>
                                                <h3 className="text-xl font-bold">Quick Quiz</h3>
                                            </div>
                                            <p className="mb-4">Take a quick 10-question quiz on random AWS domains for daily practice.</p>
                                            <button
                                                onClick={() => {
                                                    const randomDomains = [...awsDomains].sort(() => 0.5 - Math.random()).slice(0, 2);
                                                    setSelectedDomains(randomDomains);
                                                    setQuestionCount(10);
                                                    setDifficulty('medium');
                                                    generateQuestionsWithAI(randomDomains, 10, 'medium', 'quick');
                                                }}
                                                disabled={generatingQuestions}
                                                className="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                            >
                                                {generatingQuestions ? (
                                                    <div className="flex items-center justify-center space-x-2">
                                                        <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                        <span>Generating...</span>
                                                    </div>
                                                ) : (
                                                    "Start Quick Quiz"
                                                )}
                                            </button>
                                        </div>

                                        <div className={`p-6 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-indigo-50'} border-2 border-indigo-200`}>
                                            <div className="flex items-center space-x-3 mb-4">
                                                <div className="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center">
                                                    <div className="w-6 h-6 text-white"><Calculator /></div>
                                                </div>
                                                <h3 className="text-xl font-bold">Aptitude Practice</h3>
                                            </div>
                                            <p className="mb-4">Practice quantitative aptitude, logical reasoning, and verbal ability questions.</p>
                                            <button
                                                onClick={() => setShowAptitudeSelector(true)}
                                                className="w-full bg-gradient-to-r from-indigo-500 to-indigo-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                            >
                                                Start Aptitude Practice
                                            </button>
                                        </div>

                                        <div className={`p-6 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-pink-50'} border-2 border-pink-200`}>
                                            <div className="flex items-center space-x-3 mb-4">
                                                <div className="w-10 h-10 bg-pink-500 rounded-full flex items-center justify-center">
                                                    <div className="w-6 h-6 text-white"><TrendingUp /></div>
                                                </div>
                                                <h3 className="text-xl font-bold">Performance Analytics</h3>
                                            </div>
                                            <p className="mb-4">View your performance across different domains and get personalized study recommendations.</p>
                                            <button
                                                onClick={() => setShowStats(true)}
                                                className="w-full bg-gradient-to-r from-pink-500 to-pink-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                            >
                                                View Analytics
                                            </button>
                                        </div>

                                        {/* Enhanced PYQ Practice Card */}
                                        <div className={`p-6 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-teal-50'} border-2 border-teal-200`}>
                                            <div className="flex items-center space-x-3 mb-4">
                                                <div className="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center">
                                                    <div className="w-6 h-6 text-white"><FileText /></div>
                                                </div>
                                                <h3 className="text-xl font-bold">PYQ Practice</h3>
                                            </div>
                                            <p className="mb-4">Practice with Previous Year Questions uploaded by teachers. Choose question count, shuffled questions with 15% MSQ support.</p>
                                            <button
                                                onClick={() => setShowPyqPractice(true)}
                                                className="w-full bg-gradient-to-r from-teal-500 to-teal-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                            >
                                                Start PYQ Practice
                                            </button>
                                        </div>

                                        {/* Custom Practice Test Card */}
                                        <div className={`p-6 rounded-2xl ${darkMode ? 'bg-gray-700' : 'bg-yellow-50'} border-2 border-yellow-200`}>
                                            <div className="flex items-center space-x-3 mb-4">
                                                <div className="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center">
                                                    <div className="w-6 h-6 text-white"><Brain /></div>
                                                </div>
                                                <h3 className="text-xl font-bold">Custom Practice Test</h3>
                                            </div>
                                            <p className="mb-4">Generate custom AWS questions with AI based on your preferred domains and difficulty.</p>
                                            <button
                                                onClick={() => setShowQuestionGenerator(true)}
                                                className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                            >
                                                Generate Questions
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Show recent exam history for quick access */}
                                {examHistory.length > 0 && (
                                    <div className={`${cardClass} rounded-2xl p-6 shadow-lg max-w-4xl mx-auto`}>
                                        <h3 className="text-xl font-bold mb-4 flex items-center space-x-2">
                                            <History />
                                            <span>Recent Exam History</span>
                                        </h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {examHistory.slice(0, 3).map((exam, index) => (
                                                <div key={index} className="border rounded-lg p-4 hover:shadow-md transition cursor-pointer"
                                                    onClick={() => setSelectedHistoryExam(exam)}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <h4 className="font-bold">{exam.examTitle}</h4>
                                                            <p className="text-sm text-gray-500">{new Date(exam.dateCreated).toLocaleDateString()}</p>
                                                            <p className="text-xs text-blue-500 capitalize">{exam.examType || 'aws'} exam</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className={`text-lg font-bold ${exam.percentage >= 70 ? 'text-green-600' : 'text-red-600'}`}>
                                                                {exam.percentage}%
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span>{exam.score}/{exam.totalQuestions}</span>
                                                        <span className="text-blue-600">Click to review</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : showResults ? (
                            <div className="space-y-6">
                                <div className={`${cardClass} rounded-3xl shadow-2xl p-8 text-center`}>
                                    <div className={`w-32 h-32 mx-auto mb-6 rounded-full flex items-center justify-center ${passed ? 'bg-green-100' : 'bg-red-100'}`}>
                                        <div className={`w-20 h-20 ${passed ? 'text-green-600' : 'text-red-600'}`}>
                                            {passed ? <Award /> : <XCircle />}
                                        </div>
                                    </div>
                                    <h2 className="text-4xl font-bold mb-2">{passed ? ' Congratulations!' : ' Keep Practicing!'}</h2>
                                    <p className="text-xl mb-6">{passed ? 'You passed the AWS exam!' : 'Focus on weak areas and try again!'}</p>

                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                            <p className="text-sm opacity-75">Score</p>
                                            <p className="text-2xl font-bold text-blue-600">{score}/{questions.length}</p>
                                        </div>
                                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                            <p className="text-sm opacity-75">Percentage</p>
                                            <p className={`text-2xl font-bold ${passed ? 'text-green-600' : 'text-red-600'}`}>{percentage}%</p>
                                        </div>
                                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                            <p className="text-sm opacity-75">Time Spent</p>
                                            <p className="text-2xl font-bold text-purple-600">{formatTime(practiceMode ? (questionCount * 90 - timeLeft) : (9000 - timeLeft))}</p>
                                        </div>
                                        <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                            <p className="text-sm opacity-75">Status</p>
                                            <p className={`text-2xl font-bold ${passed ? 'text-green-600' : 'text-red-600'}`}>{passed ? 'PASS' : 'FAIL'}</p>
                                        </div>
                                    </div>

                                    <div className="flex flex-wrap justify-center gap-4">
                                        <button onClick={() => setShowReview(true)} className="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition flex items-center space-x-2">
                                            <div className="w-5 h-5"><Eye /></div>
                                            <span>Review Answers</span>
                                        </button>
                                        {examType === 'aws' && (
                                            <button onClick={() => setShowDomainAnalysis(true)} className="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition flex items-center space-x-2">
                                                <div className="w-5 h-5"><PieChart /></div>
                                                <span>Domain Analysis</span>
                                            </button>
                                        )}
                                        {/* NEW: Updated Try Again button to restart the same exam */}
                                        <button onClick={restartSameExam} className="px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition flex items-center space-x-2">
                                            <div className="w-5 h-5"><RotateCcw /></div>
                                            <span>Try Again (Same Questions)</span>
                                        </button>
                                    </div>
                                </div>

                                {showReview && <AnswerReview />}
                                {showDomainAnalysis && examType === 'aws' && <DomainAnalysis />}
                            </div>
                        ) : (
                            // Exam Interface
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                <div className="lg:col-span-3 space-y-6">
                                    <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="text-xl font-bold">Question {currentQuestion + 1} of {questions.length}</h3>
                                            <div className="flex items-center space-x-2">
                                                {(() => {
                                                    const question = questions[currentQuestion];
                                                    const correctAnswer = answers[currentQuestion] || '';

                                                    // Enhanced multi-select detection for PYQ questions
                                                    let isMultipleChoice = question.isMultiSelect;
                                                    if (examType === 'pyq') {
                                                        const correctAnswers = correctAnswer.split(',').map(a => a.trim()).filter(a => a);
                                                        isMultipleChoice = correctAnswers.length > 1 ||
                                                            question.question.toLowerCase().includes('choose two') ||
                                                            question.question.toLowerCase().includes('choose three') ||
                                                            question.question.toLowerCase().includes('select all') ||
                                                            question.question.toLowerCase().includes('multiple answers');
                                                    } else {
                                                        isMultipleChoice = question.isMultiSelect || correctAnswer.split(',').filter(a => a.trim()).length > 1;
                                                    }

                                                    return isMultipleChoice ? (
                                                        <span className="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">
                                                            Multiple Answers
                                                        </span>
                                                    ) : null;
                                                })()}
                                                <button
                                                    onClick={() => toggleFlag(currentQuestion)}
                                                    className={`p-2 rounded-lg transition ${flaggedQuestions.has(currentQuestion) ? 'bg-yellow-500 text-white' : darkMode ? 'bg-gray-700' : 'bg-gray-200'}`}
                                                >
                                                    <div className="w-6 h-6"><Flag /></div>
                                                </button>
                                            </div>
                                        </div>

                                        <p className="text-lg mb-6">{questions[currentQuestion].question}</p>

                                        <div className="space-y-3 mb-6">
                                            {questions[currentQuestion].options.map((option, idx) => {
                                                const optionLetter = String.fromCharCode(65 + idx);
                                                const correctAnswer = answers[currentQuestion] || '';

                                                // Enhanced multi-select detection for PYQ questions
                                                let isMulti = questions[currentQuestion].isMultiSelect;
                                                if (examType === 'pyq') {
                                                    const correctAnswers = correctAnswer.split(',').map(a => a.trim()).filter(a => a);
                                                    isMulti = correctAnswers.length > 1 ||
                                                        questions[currentQuestion].question.toLowerCase().includes('choose two') ||
                                                        questions[currentQuestion].question.toLowerCase().includes('choose three') ||
                                                        questions[currentQuestion].question.toLowerCase().includes('select all') ||
                                                        questions[currentQuestion].question.toLowerCase().includes('multiple answers');
                                                } else {
                                                    isMulti = questions[currentQuestion].isMultiSelect || correctAnswer.split(',').filter(a => a.trim()).length > 1;
                                                }

                                                const userAnswer = userAnswers[currentQuestion] || '';
                                                const isSelected = isMulti
                                                    ? userAnswer.split(',').map(a => a.trim()).includes(optionLetter)
                                                    : userAnswer === optionLetter;

                                                return (
                                                    <button
                                                        key={idx}
                                                        onClick={() => handleAnswerSelect(currentQuestion, optionLetter)}
                                                        className={`w-full p-4 rounded-xl text-left border-2 transition transform hover:scale-105 ${isSelected
                                                            ? 'border-blue-500 bg-blue-50'
                                                            : darkMode ? 'border-gray-600 bg-gray-700 hover:bg-gray-600' : 'border-gray-300 hover:bg-gray-50'
                                                            }`}
                                                    >
                                                        <div className="flex items-center space-x-3">
                                                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'border-blue-500 bg-blue-500' : 'border-gray-400'}`}>
                                                                {isSelected && <span className="text-white text-sm"></span>}
                                                            </div>
                                                            <span className="font-semibold">{optionLetter}.</span>
                                                            <span className={isSelected ? 'text-gray-900' : ''}>{option}</span>
                                                        </div>
                                                    </button>
                                                );
                                            })}
                                        </div>

                                        <div className="flex justify-between">
                                            <button
                                                onClick={() => setCurrentQuestion(Math.max(0, currentQuestion - 1))}
                                                disabled={currentQuestion === 0}
                                                className="px-6 py-3 bg-gray-500 text-white rounded-xl font-bold hover:bg-gray-600 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                 Previous
                                            </button>

                                            {currentQuestion === questions.length - 1 ? (
                                                <button
                                                    onClick={() => setShowConfirmSubmit(true)}
                                                    className="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                                >
                                                    Submit Exam 
                                                </button>
                                            ) : (
                                                <button
                                                    onClick={() => setCurrentQuestion(Math.min(questions.length - 1, currentQuestion + 1))}
                                                    className="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                                >
                                                    Next 
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                                        <h3 className="text-lg font-bold mb-4">Progress</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <div className="flex justify-between text-sm mb-2">
                                                    <span>Answered</span>
                                                    <span className="font-bold text-green-600">{answeredCount}/{questions.length}</span>
                                                </div>
                                                <div className={`h-3 ${darkMode ? 'bg-gray-700' : 'bg-gray-200'} rounded-full overflow-hidden`}>
                                                    <div className="h-full bg-gradient-to-r from-green-500 to-green-600 transition-all duration-300" style={{ width: `${(answeredCount / questions.length) * 100}%` }} />
                                                </div>
                                            </div>
                                            <div>
                                                <div className="flex justify-between text-sm mb-2">
                                                    <span>Unanswered</span>
                                                    <span className="font-bold text-orange-600">{unansweredCount}</span>
                                                </div>
                                            </div>
                                            <div>
                                                <div className="flex justify-between text-sm mb-2">
                                                    <span>Flagged</span>
                                                    <span className="font-bold text-yellow-600">{flaggedCount}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className={`${cardClass} rounded-2xl p-6 shadow-lg`}>
                                        <h3 className="text-lg font-bold mb-4">Question Navigator</h3>
                                        <div className="grid grid-cols-5 gap-2 max-h-96 overflow-y-auto">
                                            {questions.map((q, idx) => {
                                                const isAnswered = userAnswers[idx];
                                                const isFlagged = flaggedQuestions.has(idx);
                                                const isCurrent = idx === currentQuestion;

                                                // Enhanced multi-select detection for PYQ questions
                                                let isMultiSelect = q.isMultiSelect;
                                                if (examType === 'pyq') {
                                                    const correctAnswer = answers[idx] || '';
                                                    const correctAnswers = correctAnswer.split(',').map(a => a.trim()).filter(a => a);
                                                    isMultiSelect = correctAnswers.length > 1 ||
                                                        q.question.toLowerCase().includes('choose two') ||
                                                        q.question.toLowerCase().includes('choose three') ||
                                                        q.question.toLowerCase().includes('select all') ||
                                                        q.question.toLowerCase().includes('multiple answers');
                                                } else {
                                                    isMultiSelect = q.isMultiSelect;
                                                }

                                                return (
                                                    <button
                                                        key={idx}
                                                        onClick={() => setCurrentQuestion(idx)}
                                                        className={`aspect-square rounded-lg font-bold text-sm transition transform hover:scale-110 relative ${isCurrent
                                                            ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg'
                                                            : isAnswered
                                                                ? 'bg-green-500 text-white'
                                                                : darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-200 text-gray-700'
                                                            }`}
                                                    >
                                                        {idx + 1}
                                                        {isFlagged && (
                                                            <div className="absolute -top-1 -right-1 w-4 h-4 bg-yellow-500 rounded-full flex items-center justify-center">
                                                                <span className="text-xs"></span>
                                                            </div>
                                                        )}
                                                        {isMultiSelect && (
                                                            <div className="absolute -top-1 -left-1 w-4 h-4 bg-purple-500 rounded-full flex items-center justify-center">
                                                                <span className="text-xs text-white">M</span>
                                                            </div>
                                                        )}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <button
                                        onClick={() => setShowConfirmSubmit(true)}
                                        className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transform hover:scale-105 transition"
                                    >
                                        Submit Exam
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Stats Modal with Full History (keep existing) */}
                    {showStats && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                            <div className={`${cardClass} rounded-2xl p-8 max-w-4xl w-full shadow-2xl my-8`}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-bold">Your Complete Exam History</h3>
                                    <button onClick={() => setShowStats(false)} className="text-gray-500 hover:text-gray-700 text-2xl"></button>
                                </div>

                                {examHistory.length > 0 ? (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                            <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                                <p className="text-sm opacity-75">Total Attempts</p>
                                                <p className="text-2xl font-bold text-blue-600">{examHistory.length}</p>
                                            </div>
                                            <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                                <p className="text-sm opacity-75">Average Score</p>
                                                <p className="text-2xl font-bold text-green-600">
                                                    {(examHistory.reduce((sum, h) => sum + parseFloat(h.percentage), 0) / examHistory.length).toFixed(1)}%
                                                </p>
                                            </div>
                                            <div className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                                                <p className="text-sm opacity-75">Best Score</p>
                                                <p className="text-2xl font-bold text-purple-600">
                                                    {Math.max(...examHistory.map(h => parseFloat(h.percentage)))}%
                                                </p>
                                            </div>
                                        </div>

                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                            {examHistory.map((exam, idx) => (
                                                <div key={idx} className={`p-4 rounded-xl ${darkMode ? 'bg-gray-700' : 'bg-gray-50'} hover:shadow-lg transition cursor-pointer`}
                                                    onClick={() => {
                                                        setSelectedHistoryExam(exam);
                                                        setShowStats(false);
                                                    }}>
                                                    <div className="flex justify-between items-center">
                                                        <div>
                                                            <h4 className="font-bold">{exam.examTitle}</h4>
                                                            <p className="text-sm opacity-75">{new Date(exam.dateCreated).toLocaleString()}</p>
                                                            <p className="text-xs text-blue-500 capitalize">{exam.examType || 'aws'} exam</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className={`text-2xl font-bold ${parseFloat(exam.percentage) >= 70 ? 'text-green-600' : 'text-red-600'}`}>
                                                                {exam.percentage}%
                                                            </p>
                                                            <p className="text-sm">{exam.score}/{exam.totalQuestions}</p>
                                                            <p className="text-xs text-blue-600 mt-1">Click to review full exam</p>
                                                        </div>
                                                    </div>
                                                    <div className="mt-2 flex items-center space-x-4 text-sm">
                                                        <span className="flex items-center space-x-1">
                                                            <Clock />
                                                            <span>{formatTime(exam.timeSpent)}</span>
                                                        </span>
                                                        <span className={`px-3 py-1 rounded-full ${parseFloat(exam.percentage) >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                            {parseFloat(exam.percentage) >= 70 ? 'Pass ' : 'Fail '}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : (
                                    <p className="text-center text-gray-500 py-8">No exam history available</p>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Confirm Submit Modal (keep existing) */}
                    {showConfirmSubmit && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className={`${cardClass} rounded-2xl p-8 max-w-md w-full shadow-2xl transform scale-100 animate-pulse`}>
                                <div className="text-center">
                                    <div className="w-16 h-16 mx-auto mb-4 bg-yellow-100 rounded-full flex items-center justify-center">
                                        <div className="w-10 h-10 text-yellow-600"><AlertCircle /></div>
                                    </div>
                                    <h3 className="text-2xl font-bold mb-4">Confirm Submission</h3>
                                    <p className="mb-6">Are you sure you want to submit your AWS exam?</p>
                                    <div className="space-y-2 mb-6 text-left">
                                        <p className="flex justify-between">
                                            <span>Answered:</span>
                                            <span className="font-bold text-green-600">{answeredCount} questions</span>
                                        </p>
                                        <p className="flex justify-between">
                                            <span>Unanswered:</span>
                                            <span className="font-bold text-red-600">{unansweredCount} questions</span>
                                        </p>
                                        <p className="flex justify-between">
                                            <span>Flagged:</span>
                                            <span className="font-bold text-yellow-600">{flaggedCount} questions</span>
                                        </p>
                                    </div>
                                    <div className="flex space-x-4">
                                        <button
                                            onClick={() => setShowConfirmSubmit(false)}
                                            className="flex-1 px-6 py-3 bg-gray-500 text-white rounded-xl font-bold hover:bg-gray-600 transition"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={handleSubmit}
                                            className="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold hover:shadow-xl transform hover:scale-105 transition"
                                        >
                                            Submit
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Domain Selector Modal (keep existing) */}
                    {showDomainSelector && <DomainSelector />}

                    {/* Service Selector Modal (NEW) */}
                    {showServiceSelector && <ServiceSelector />}

                    {/* Aptitude Selector Modal (keep existing) */}
                    {showAptitudeSelector && <AptitudeSelector />}

                    {/* Question Generator Modal (keep existing) */}
                    {showQuestionGenerator && <QuestionGenerator />}

                    {/* PYQ Upload Modal (keep existing) */}
                    {showPyqUpload && <PyqUpload />}

                    {/* PYQ Practice Selector Modal (keep existing) */}
                    {showPyqPractice && <PyqPracticeSelector />}

                    {/* PYQ Question Count Selector Modal (keep existing) */}
                    {showPyqQuestionCountSelector && <PyqQuestionCountSelector />}

                    {/* Explanation Modal (keep existing) */}
                    {showExplanation && <ExplanationModal />}
                </div>
            );
        };

        ReactDOM.render(<ExamSystem />, document.getElementById('root'));
    </script>
</body>

</html>
